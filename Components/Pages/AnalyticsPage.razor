@page "/analytics"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using PersonalJournalApp.Models.Display
@using PersonalJournalApp.Services
@using PersonalJournalApp.Auth
@using PersonalJournalApp.Data
@inject AuthenticationStateProvider AuthStateProvider
@inject CustomAuthStateProvider CustomAuthStateProvider
@inject NavigationManager Navigation
@inject JournalService JournalService
@inject TagService TagService
@inject AppDbContext DbContext
@inject PersonalJournalApp.Services.PdfExportService PdfExportService

@if (!isAuthorized)
{
    <p>Redirecting...</p>
}
else if (isLoading)
{
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading analytics...</p>
    </div>
}
else
{
    <div class="page-content">
        <div class="page-header">
            <div class="header-left">
                <h1>Analytics</h1>
                <p class="page-subtitle">Insights and statistics from your journal</p>
            </div>
            <div class="header-actions">
                <select class="period-select" @bind="selectedPeriod" @bind:after="OnPeriodChanged">
                    <option value="7">Last 7 Days</option>
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 3 Months</option>
                    <option value="365">This Year</option>
                    <option value="0">All Time</option>
                </select>
                <button class="btn btn-primary" @onclick="ExportReport">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export Report
                </button>
            </div>
        </div>

        <!-- Overview Stats -->
        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@analytics.TotalEntries</div>
                    <div class="stat-label">Total Entries</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@analytics.CurrentStreak</div>
                    <div class="stat-label">Current Streak</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="4 17 10 11 4 5"></polyline>
                        <line x1="12" y1="19" x2="20" y2="19"></line>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@analytics.AverageWordsPerEntry.ToString("F0")</div>
                    <div class="stat-label">Avg Words/Entry</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                        <polyline points="22 4 12 14.01 9 11.01"></polyline>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@analytics.CompletionRate%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
            </div>
        </div>

        <!-- Mood Category Breakdown -->
        <div class="mood-breakdown-section">
            <h3 class="section-title">Mood Overview</h3>
            @if (analytics.TotalEntries > 0)
            {
                <div class="mood-overview-grid">
                    <div class="mood-ring-container">
                        <div class="mood-ring">
                            <svg viewBox="0 0 120 120">
                                @{
                                    var total = analytics.PositiveMoodPercentage + analytics.NeutralMoodPercentage + analytics.NegativeMoodPercentage;
                                    var circumference = 2 * Math.PI * 45;
                                    var positiveOffset = 0.0;
                                    var neutralOffset = (analytics.PositiveMoodPercentage / 100.0) * circumference;
                                    var negativeOffset = neutralOffset + (analytics.NeutralMoodPercentage / 100.0) * circumference;
                                }
                                <!-- Background circle -->
                                <circle cx="60" cy="60" r="45" fill="none" stroke="var(--border-color)" stroke-width="12" />
                                <!-- Positive segment -->
                                <circle cx="60" cy="60" r="45" fill="none"
                                        stroke="#a78bfa" stroke-width="12"
                                        stroke-dasharray="@((analytics.PositiveMoodPercentage / 100.0) * circumference) @circumference"
                                        stroke-dashoffset="0"
                                        transform="rotate(-90 60 60)" />
                                <!-- Neutral segment -->
                                <circle cx="60" cy="60" r="45" fill="none"
                                        stroke="#9ca3af" stroke-width="12"
                                        stroke-dasharray="@((analytics.NeutralMoodPercentage / 100.0) * circumference) @circumference"
                                        stroke-dashoffset="@(-neutralOffset)"
                                        transform="rotate(-90 60 60)" />
                                <!-- Negative segment -->
                                <circle cx="60" cy="60" r="45" fill="none"
                                        stroke="#6b7280" stroke-width="12"
                                        stroke-dasharray="@((analytics.NegativeMoodPercentage / 100.0) * circumference) @circumference"
                                        stroke-dashoffset="@(-negativeOffset)"
                                        transform="rotate(-90 60 60)" />
                            </svg>
                            <div class="mood-ring-center">
                                <span class="mood-ring-value">@analytics.TotalEntries</span>
                                <span class="mood-ring-label">Entries</span>
                            </div>
                        </div>
                    </div>
                    <div class="mood-legend">
                        <div class="mood-legend-item">
                            <div class="legend-dot positive"></div>
                            <div class="legend-info">
                                <span class="legend-label">Positive</span>
                                <span class="legend-value">@analytics.PositiveMoodPercentage%</span>
                            </div>
                            <div class="legend-bar">
                                <div class="legend-bar-fill positive" style="width: @analytics.PositiveMoodPercentage%;"></div>
                            </div>
                        </div>
                        <div class="mood-legend-item">
                            <div class="legend-dot neutral"></div>
                            <div class="legend-info">
                                <span class="legend-label">Neutral</span>
                                <span class="legend-value">@analytics.NeutralMoodPercentage%</span>
                            </div>
                            <div class="legend-bar">
                                <div class="legend-bar-fill neutral" style="width: @analytics.NeutralMoodPercentage%;"></div>
                            </div>
                        </div>
                        <div class="mood-legend-item">
                            <div class="legend-dot negative"></div>
                            <div class="legend-info">
                                <span class="legend-label">Negative</span>
                                <span class="legend-value">@analytics.NegativeMoodPercentage%</span>
                            </div>
                            <div class="legend-bar">
                                <div class="legend-bar-fill negative" style="width: @analytics.NegativeMoodPercentage%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="empty-mood-overview">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="48" height="48">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                        <line x1="9" y1="9" x2="9.01" y2="9"></line>
                        <line x1="15" y1="9" x2="15.01" y2="9"></line>
                    </svg>
                    <p>No mood data yet. Start journaling to see your mood patterns!</p>
                </div>
            }
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">
            <!-- Mood Distribution -->
            <div class="card chart-card">
                <div class="chart-header">
                    <h3>Mood Distribution</h3>
                    <span class="chart-subtitle">@GetPeriodLabel()</span>
                </div>
                <div class="chart-content">
                    @if (analytics.MoodCounts.Any())
                    {
                        <div class="mood-chart">
                            @foreach (var mood in analytics.MoodCounts.OrderByDescending(m => m.Value).Take(8))
                            {
                                var maxCount = analytics.MoodCounts.Values.Max();
                                var heightPercent = maxCount > 0 ? (mood.Value * 100.0 / maxCount) : 0;
                                <div class="mood-bar-group">
                                    <div class="mood-bar-container">
                                        <div class="mood-bar" style="height: @heightPercent%;" data-mood="@mood.Key"></div>
                                    </div>
                                    <div class="mood-label">@CapitalizeFirst(mood.Key)</div>
                                    <div class="mood-count">@mood.Value</div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-chart">
                            <p>No entries in this period</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Category Distribution -->
            <div class="card chart-card">
                <div class="chart-header">
                    <h3>Category Distribution</h3>
                    <span class="chart-subtitle">Entries by category</span>
                </div>
                <div class="chart-content">
                    @if (analytics.CategoryCounts.Any())
                    {
                        <div class="category-chart">
                            @{
                                var categoryColors = new[] { "#8b5cf6", "#a78bfa", "#c4b5fd", "#6b7280", "#9ca3af", "#d1d5db", "#7c3aed", "#6366f1" };
                                var maxCategoryCount = analytics.CategoryCounts.Values.Max();
                                var colorIndex = 0;
                            }
                            @foreach (var category in analytics.CategoryCounts.OrderByDescending(c => c.Value))
                            {
                                var percentage = analytics.TotalEntries > 0 ? (category.Value * 100.0 / analytics.TotalEntries) : 0;
                                var color = categoryColors[colorIndex % categoryColors.Length];
                                colorIndex++;
                                <div class="category-item">
                                    <div class="category-info">
                                        <div class="category-name-row">
                                            <div class="category-color-dot" style="background: @color;"></div>
                                            <span class="category-name">@(string.IsNullOrEmpty(category.Key) ? "Uncategorized" : category.Key)</span>
                                        </div>
                                        <div class="category-bar">
                                            <div class="category-bar-fill" style="width: @percentage%; background: @color;"></div>
                                        </div>
                                    </div>
                                    <div class="category-stats">
                                        <span class="category-count">@category.Value</span>
                                        <span class="category-percent">@percentage.ToString("F1")%</span>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-chart">
                            <p>No category data available</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Second Row - Line Charts -->
        <div class="charts-grid">
            <!-- Writing Frequency Line Chart -->
            <div class="card chart-card">
                <div class="chart-header">
                    <h3>Writing Frequency</h3>
                    <span class="chart-subtitle">Entries over time</span>
                </div>
                <div class="chart-content">
                    @if (analytics.WeeklyFrequency.Any())
                    {
                        <div class="line-chart-container">
                            <svg viewBox="0 0 400 200" class="line-chart">
                                @{
                                    var freqData = analytics.WeeklyFrequency.TakeLast(12).ToList();
                                    var maxFreq = freqData.Max(f => f.Value);
                                    var freqPoints = new List<string>();
                                    var chartWidth = 400;
                                    var chartHeight = 200;
                                    var padding = 20;
                                    var usableWidth = chartWidth - (padding * 2);
                                    var usableHeight = chartHeight - (padding * 2);

                                    for (int i = 0; i < freqData.Count; i++)
                                    {
                                        var x = padding + (i * usableWidth / (freqData.Count - 1 > 0 ? freqData.Count - 1 : 1));
                                        var y = chartHeight - padding - (freqData[i].Value * usableHeight / (maxFreq > 0 ? maxFreq : 1));
                                        freqPoints.Add($"{x},{y}");
                                    }
                                    var freqPath = string.Join(" ", freqPoints);
                                }

                                <!-- Grid lines -->
                                @for (int i = 0; i <= 4; i++)
                                {
                                    var y = padding + (i * usableHeight / 4);
                                    <line x1="@padding" y1="@y" x2="@(chartWidth - padding)" y2="@y"
                                          stroke="var(--border-color)" stroke-width="1" opacity="0.3" />
                                }

                                <!-- Line path -->
                                @if (freqPoints.Count > 1)
                                {
                                    <polyline points="@freqPath" fill="none" stroke="var(--primary)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />

                                    <!-- Area under line -->
                                    var areaPath = $"M {padding},{chartHeight - padding} " + freqPath + $" L {chartWidth - padding},{chartHeight - padding} Z";
                                    <path d="@areaPath" fill="var(--primary)" opacity="0.1" />

                                    <!-- Data points -->
                                    @for (int i = 0; i < freqData.Count; i++)
                                    {
                                        var x = padding + (i * usableWidth / (freqData.Count - 1 > 0 ? freqData.Count - 1 : 1));
                                        var y = chartHeight - padding - (freqData[i].Value * usableHeight / (maxFreq > 0 ? maxFreq : 1));
                                        <circle cx="@x" cy="@y" r="4" fill="var(--primary)" stroke="white" stroke-width="2" />
                                    }
                                }
                            </svg>
                            <div class="line-chart-labels">
                                @foreach (var point in freqData)
                                {
                                    <div class="line-chart-label">
                                        <span class="label-text">@point.Key</span>
                                        <span class="label-value">@point.Value</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="empty-chart">
                            <p>No data available</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Word Count Trend Line Chart -->
            <div class="card chart-card">
                <div class="chart-header">
                    <h3>Word Count Trend</h3>
                    <span class="chart-subtitle">Average words per entry over time</span>
                </div>
                <div class="chart-content">
                    @if (analytics.WordCountTrend.Any())
                    {
                        <div class="line-chart-container">
                            <svg viewBox="0 0 400 200" class="line-chart">
                                @{
                                    var wordData = analytics.WordCountTrend.TakeLast(12).ToList();
                                    var maxWords = wordData.Max(w => w.Value);
                                    var minWords = wordData.Min(w => w.Value);
                                    var wordRange = maxWords - minWords;
                                    var wordPoints = new List<string>();
                                    var chartWidth = 400;
                                    var chartHeight = 200;
                                    var padding = 20;
                                    var usableWidth = chartWidth - (padding * 2);
                                    var usableHeight = chartHeight - (padding * 2);

                                    for (int i = 0; i < wordData.Count; i++)
                                    {
                                        var x = padding + (i * usableWidth / (wordData.Count - 1 > 0 ? wordData.Count - 1 : 1));
                                        var normalizedValue = wordRange > 0 ? (wordData[i].Value - minWords) : 0;
                                        var y = chartHeight - padding - (normalizedValue * usableHeight / (wordRange > 0 ? wordRange : 1));
                                        wordPoints.Add($"{x},{y}");
                                    }
                                    var wordPath = string.Join(" ", wordPoints);
                                }

                                <!-- Grid lines -->
                                @for (int i = 0; i <= 4; i++)
                                {
                                    var y = padding + (i * usableHeight / 4);
                                    <line x1="@padding" y1="@y" x2="@(chartWidth - padding)" y2="@y"
                                          stroke="var(--border-color)" stroke-width="1" opacity="0.3" />
                                }

                                <!-- Line path -->
                                @if (wordPoints.Count > 1)
                                {
                                    <polyline points="@wordPath" fill="none" stroke="#6366f1" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" />

                                    <!-- Area under line -->
                                    var areaPath = $"M {padding},{chartHeight - padding} " + wordPath + $" L {chartWidth - padding},{chartHeight - padding} Z";
                                    <path d="@areaPath" fill="#6366f1" opacity="0.1" />

                                    <!-- Data points -->
                                    @for (int i = 0; i < wordData.Count; i++)
                                    {
                                        var x = padding + (i * usableWidth / (wordData.Count - 1 > 0 ? wordData.Count - 1 : 1));
                                        var normalizedValue = wordRange > 0 ? (wordData[i].Value - minWords) : 0;
                                        var y = chartHeight - padding - (normalizedValue * usableHeight / (wordRange > 0 ? wordRange : 1));
                                        <circle cx="@x" cy="@y" r="4" fill="#6366f1" stroke="white" stroke-width="2" />
                                    }
                                }
                            </svg>
                            <div class="line-chart-labels">
                                @foreach (var point in wordData)
                                {
                                    <div class="line-chart-label">
                                        <span class="label-text">@point.Key</span>
                                        <span class="label-value">@point.Value</span>
                                    </div>
                                }
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="empty-chart">
                            <p>No data available</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Third Row -->
        <div class="charts-grid">
            <!-- Top Tags -->
            <div class="card chart-card">
                <div class="chart-header">
                    <h3>Most Used Tags</h3>
                    <span class="chart-subtitle">Top 10 tags</span>
                </div>
                <div class="chart-content">
                    @if (analytics.TopTags.Any())
                    {
                        <div class="tags-list">
                            @foreach (var tag in analytics.TopTags.Take(10))
                            {
                                var maxUsage = analytics.TopTags.Max(t => t.UsageCount);
                                var widthPercent = maxUsage > 0 ? (tag.UsageCount * 100.0 / maxUsage) : 0;
                                <div class="tag-item">
                                    <div class="tag-info">
                                        <span class="tag-name">@tag.TagName</span>
                                        <div class="tag-bar">
                                            <div class="tag-bar-fill" style="width: @widthPercent%;"></div>
                                        </div>
                                    </div>
                                    <span class="tag-count">@tag.UsageCount</span>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-chart">
                            <p>No tags used yet</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Writing Time Distribution -->
            <div class="card chart-card">
                <div class="chart-header">
                    <h3>Writing Time Distribution</h3>
                    <span class="chart-subtitle">When you journal most</span>
                </div>
                <div class="chart-content">
                    <div class="time-distribution">
                        @foreach (var timeSlot in analytics.TimeDistribution)
                        {
                            var maxCount = analytics.TimeDistribution.Values.Max();
                            var heightPercent = maxCount > 0 ? (timeSlot.Value * 100.0 / maxCount) : 0;
                            <div class="time-slot @(timeSlot.Key == analytics.MostActiveTimeSlot ? "active" : "")">
                                <div class="time-bar-container">
                                    <div class="time-bar" style="height: @Math.Max(heightPercent, 5)%;"></div>
                                </div>
                                <div class="time-label">@timeSlot.Key</div>
                                <div class="time-count">@timeSlot.Value</div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Fourth Row - Achievement Stats -->
        <div class="charts-grid">
            <div class="card chart-card">
                <div class="chart-header">
                    <h3>Achievement Stats</h3>
                    <span class="chart-subtitle">Your journaling milestones</span>
                </div>
                <div class="chart-content">
                    <div class="achievement-stats">
                        <div class="achievement-item">
                            <div class="achievement-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                                </svg>
                            </div>
                            <div class="achievement-info">
                                <div class="achievement-value">@analytics.LongestStreak</div>
                                <div class="achievement-label">Longest Streak</div>
                            </div>
                        </div>
                        <div class="achievement-item">
                            <div class="achievement-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </div>
                            <div class="achievement-info">
                                <div class="achievement-value">@analytics.TotalWords.ToString("N0")</div>
                                <div class="achievement-label">Total Words Written</div>
                            </div>
                        </div>
                        <div class="achievement-item">
                            <div class="achievement-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                            </div>
                            <div class="achievement-info">
                                <div class="achievement-value">@analytics.DaysJournaling</div>
                                <div class="achievement-label">Days Journaling</div>
                            </div>
                        </div>
                        <div class="achievement-item">
                            <div class="achievement-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                    <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                    <line x1="7" y1="7" x2="7.01" y2="7"></line>
                                </svg>
                            </div>
                            <div class="achievement-info">
                                <div class="achievement-value">@analytics.UniqueTags</div>
                                <div class="achievement-label">Unique Tags Used</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Placeholder for future chart -->
            <div class="card chart-card">
                <div class="chart-header">
                    <h3>Categories Overview</h3>
                    <span class="chart-subtitle">@analytics.UniqueCategories @(analytics.UniqueCategories == 1 ? "category" : "categories") used</span>
                </div>
                <div class="chart-content">
                    @if (analytics.CategoryCounts.Any())
                    {
                        <div class="category-overview-stats">
                            <div class="category-stat-item">
                                <div class="category-stat-label">Most Used Category</div>
                                <div class="category-stat-value">
                                    @(analytics.CategoryCounts.OrderByDescending(c => c.Value).First().Key ?? "Uncategorized")
                                </div>
                                <div class="category-stat-count">
                                    @analytics.CategoryCounts.OrderByDescending(c => c.Value).First().Value entries
                                </div>
                            </div>
                            <div class="category-stat-item">
                                <div class="category-stat-label">Uncategorized Entries</div>
                                <div class="category-stat-value">
                                    @analytics.CategoryCounts.GetValueOrDefault("", 0)
                                </div>
                                <div class="category-stat-count">
                                    @((analytics.TotalEntries > 0 ? analytics.CategoryCounts.GetValueOrDefault("", 0) * 100.0 / analytics.TotalEntries : 0).ToString("F1"))% of total
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="empty-chart">
                            <p>No category data available</p>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Insights Section -->
        <div class="insights-section">
            <h2 class="section-title">Key Insights</h2>
            <div class="insights-grid">
                @if (analytics.CurrentStreak > 0)
                {
                    <div class="insight-card">
                        <div class="insight-icon positive">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
                            </svg>
                        </div>
                        <div class="insight-content">
                            <h4>@analytics.CurrentStreak Day Streak!</h4>
                            <p>You're on a @analytics.CurrentStreak-day writing streak! Keep it up to maintain your momentum.</p>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(analytics.MostActiveTimeSlot) && analytics.TotalEntries > 0)
                {
                    <div class="insight-card">
                        <div class="insight-icon neutral">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="insight-content">
                            <h4>Most Active Time</h4>
                            <p>You journal most frequently during the @analytics.MostActiveTimeSlot. This is your prime writing time!</p>
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(analytics.MostCommonMood))
                {
                    <div class="insight-card">
                        <div class="insight-icon @GetMoodInsightClass(analytics.MostCommonMood)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                        </div>
                        <div class="insight-content">
                            <h4>Dominant Mood: @CapitalizeFirst(analytics.MostCommonMood)</h4>
                            <p>@GetMoodInsightText(analytics.MostCommonMood, analytics.MoodCounts.GetValueOrDefault(analytics.MostCommonMood, 0), analytics.TotalEntries)</p>
                        </div>
                    </div>
                }

                @if (analytics.WordCountGrowth != 0)
                {
                    <div class="insight-card">
                        <div class="insight-icon @(analytics.WordCountGrowth > 0 ? "positive" : "neutral")">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <polyline points="@(analytics.WordCountGrowth > 0 ? "23 6 13.5 15.5 8.5 10.5 1 18" : "23 18 13.5 8.5 8.5 13.5 1 6")"></polyline>
                                <polyline points="@(analytics.WordCountGrowth > 0 ? "17 6 23 6 23 12" : "17 18 23 18 23 12")"></polyline>
                            </svg>
                        </div>
                        <div class="insight-content">
                            <h4>Word Count @(analytics.WordCountGrowth > 0 ? "Growing" : "Trend")</h4>
                            <p>Your average entry length has @(analytics.WordCountGrowth > 0 ? "increased" : "decreased") by @Math.Abs(analytics.WordCountGrowth) words compared to your earlier entries.</p>
                        </div>
                    </div>
                }

                @if (analytics.TopTags.Any())
                {
                    <div class="insight-card">
                        <div class="insight-icon neutral">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                <line x1="7" y1="7" x2="7.01" y2="7"></line>
                            </svg>
                        </div>
                        <div class="insight-content">
                            <h4>Top Focus: @analytics.TopTags.First().TagName</h4>
                            <p>You've used the "@analytics.TopTags.First().TagName" tag @analytics.TopTags.First().UsageCount times. It seems to be an important topic for you!</p>
                        </div>
                    </div>
                }

                @if (analytics.PositiveMoodPercentage >= 60)
                {
                    <div class="insight-card">
                        <div class="insight-icon positive">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                <polyline points="22 4 12 14.01 9 11.01"></polyline>
                            </svg>
                        </div>
                        <div class="insight-content">
                            <h4>Positive Outlook</h4>
                            <p>@analytics.PositiveMoodPercentage% of your entries show positive moods. You're maintaining a great mindset!</p>
                        </div>
                    </div>
                }

                @if (analytics.CategoryCounts.Any() && analytics.CategoryCounts.Count > 1)
                {
                    var topCategory = analytics.CategoryCounts.OrderByDescending(c => c.Value).First();
                    var topCategoryName = string.IsNullOrEmpty(topCategory.Key) ? "Uncategorized" : topCategory.Key;
                    <div class="insight-card">
                        <div class="insight-icon neutral">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <div class="insight-content">
                            <h4>Favorite Category: @topCategoryName</h4>
                            <p>Most of your entries (@topCategory.Value) belong to "@topCategoryName". This appears to be a key theme in your life.</p>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthorized = false;
    private bool isLoading = true;
    private string? currentUserId;
    private int selectedPeriod = 90; // Default: Last 3 months

    private AnalyticsData analytics = new();
    private List<JournalEntryDisplayModel> allEntries = new();

    // Mood categories
    private readonly List<string> positiveMoods = new() { "happy", "excited", "relaxed", "grateful", "confident" };
    private readonly List<string> neutralMoods = new() { "calm", "thoughtful", "curious", "nostalgic", "bored" };
    private readonly List<string> negativeMoods = new() { "sad", "angry", "anxious", "stressed", "tired" };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        isAuthorized = true;
        currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

        if (string.IsNullOrEmpty(currentUserId))
        {
            currentUserId = CustomAuthStateProvider.GetCurrentUserId();
        }

        await LoadAnalytics();
        isLoading = false;
    }

    private async Task OnPeriodChanged()
    {
        isLoading = true;
        StateHasChanged();
        await LoadAnalytics();
        isLoading = false;
        StateHasChanged();
    }

    private async Task LoadAnalytics()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;

        // Get all entries for the user
        var result = await JournalService.GetAllEntriesAsync(currentUserId);
        if (!result.Success || result.Data == null)
        {
            allEntries = new List<JournalEntryDisplayModel>();
        }
        else
        {
            allEntries = result.Data;
        }

        // Filter by selected period
        var filteredEntries = FilterEntriesByPeriod(allEntries);

        // Calculate all analytics
        analytics = CalculateAnalytics(filteredEntries, allEntries);
    }

    private List<JournalEntryDisplayModel> FilterEntriesByPeriod(List<JournalEntryDisplayModel> entries)
    {
        if (selectedPeriod == 0) return entries; // All time

        var cutoffDate = DateTime.UtcNow.AddDays(-selectedPeriod);
        return entries.Where(e => e.CreatedDate >= cutoffDate).ToList();
    }

    private AnalyticsData CalculateAnalytics(List<JournalEntryDisplayModel> filteredEntries, List<JournalEntryDisplayModel> allEntries)
    {
        var analytics = new AnalyticsData();

        // Basic stats
        analytics.TotalEntries = filteredEntries.Count;
        analytics.TotalWords = filteredEntries.Sum(e => e.WordCount);
        analytics.AverageWordsPerEntry = filteredEntries.Any() ? filteredEntries.Average(e => e.WordCount) : 0;

        // Calculate streaks using all entries
        CalculateStreaks(allEntries, analytics);

        // Completion rate (entries / days in period)
        var daysInPeriod = selectedPeriod == 0
            ? (allEntries.Any() ? (DateTime.UtcNow - allEntries.Min(e => e.CreatedDate)).Days + 1 : 1)
            : selectedPeriod;
        analytics.CompletionRate = daysInPeriod > 0 ? Math.Min((int)(filteredEntries.Count * 100.0 / daysInPeriod), 100) : 0;

        // Days journaling
        analytics.DaysJournaling = filteredEntries.Select(e => e.CreatedDate.Date).Distinct().Count();

        // Mood distribution
        analytics.MoodCounts = new Dictionary<string, int>();
        foreach (var entry in filteredEntries)
        {
            foreach (var mood in entry.AllMoods)
            {
                if (!analytics.MoodCounts.ContainsKey(mood))
                    analytics.MoodCounts[mood] = 0;
                analytics.MoodCounts[mood]++;
            }
        }

        // Most common mood
        analytics.MostCommonMood = analytics.MoodCounts.Any()
            ? analytics.MoodCounts.OrderByDescending(m => m.Value).First().Key
            : "";

        // Mood category percentages
        var totalMoodEntries = filteredEntries.Count;
        if (totalMoodEntries > 0)
        {
            var positiveCount = filteredEntries.Count(e => positiveMoods.Contains(e.PrimaryMood));
            var neutralCount = filteredEntries.Count(e => neutralMoods.Contains(e.PrimaryMood));
            var negativeCount = filteredEntries.Count(e => negativeMoods.Contains(e.PrimaryMood));

            analytics.PositiveMoodPercentage = (int)(positiveCount * 100.0 / totalMoodEntries);
            analytics.NeutralMoodPercentage = (int)(neutralCount * 100.0 / totalMoodEntries);
            analytics.NegativeMoodPercentage = (int)(negativeCount * 100.0 / totalMoodEntries);
        }

        // Category distribution
        analytics.CategoryCounts = new Dictionary<string, int>();
        foreach (var entry in filteredEntries)
        {
            var categoryName = entry.CategoryName ?? "";
            if (!analytics.CategoryCounts.ContainsKey(categoryName))
                analytics.CategoryCounts[categoryName] = 0;
            analytics.CategoryCounts[categoryName]++;
        }
        analytics.UniqueCategories = analytics.CategoryCounts.Count(c => !string.IsNullOrEmpty(c.Key));

        // Weekly frequency
        analytics.WeeklyFrequency = new Dictionary<string, int>();
        var weeks = filteredEntries
            .GroupBy(e => GetWeekLabel(e.CreatedDate))
            .OrderBy(g => g.Min(e => e.CreatedDate));
        foreach (var week in weeks)
        {
            analytics.WeeklyFrequency[week.Key] = week.Count();
        }

        // Top tags
        var tagCounts = new Dictionary<string, int>();
        foreach (var entry in filteredEntries)
        {
            foreach (var tag in entry.TagNames)
            {
                if (!tagCounts.ContainsKey(tag))
                    tagCounts[tag] = 0;
                tagCounts[tag]++;
            }
        }
        analytics.TopTags = tagCounts
            .OrderByDescending(t => t.Value)
            .Select(t => new TagUsageDisplayModel { TagName = t.Key, UsageCount = t.Value })
            .ToList();
        analytics.UniqueTags = tagCounts.Count;

        // Word count trend (by week)
        analytics.WordCountTrend = new Dictionary<string, int>();
        var wordsByWeek = filteredEntries
            .GroupBy(e => GetWeekLabel(e.CreatedDate))
            .OrderBy(g => g.Min(e => e.CreatedDate));
        foreach (var week in wordsByWeek)
        {
            analytics.WordCountTrend[week.Key] = (int)week.Average(e => e.WordCount);
        }

        // Word count growth
        if (analytics.WordCountTrend.Count >= 2)
        {
            var firstAvg = analytics.WordCountTrend.First().Value;
            var lastAvg = analytics.WordCountTrend.Last().Value;
            analytics.WordCountGrowth = lastAvg - firstAvg;
        }

        // Time distribution
        analytics.TimeDistribution = new Dictionary<string, int>
        {
            { "Morning", 0 },
            { "Afternoon", 0 },
            { "Evening", 0 },
            { "Night", 0 }
        };
        foreach (var entry in filteredEntries)
        {
            var hour = entry.CreatedDate.ToLocalTime().Hour;
            var timeSlot = hour switch
            {
                >= 5 and < 12 => "Morning",
                >= 12 and < 17 => "Afternoon",
                >= 17 and < 21 => "Evening",
                _ => "Night"
            };
            analytics.TimeDistribution[timeSlot]++;
        }
        analytics.MostActiveTimeSlot = analytics.TimeDistribution.Any()
            ? analytics.TimeDistribution.OrderByDescending(t => t.Value).First().Key
            : "";

        return analytics;
    }

    private void CalculateStreaks(List<JournalEntryDisplayModel> entries, AnalyticsData analytics)
    {
        if (!entries.Any())
        {
            analytics.CurrentStreak = 0;
            analytics.LongestStreak = 0;
            return;
        }

        var entryDates = entries
            .Select(e => e.CreatedDate.ToLocalTime().Date)
            .Distinct()
            .OrderByDescending(d => d)
            .ToList();

        var today = DateTime.Now.Date;
        var yesterday = today.AddDays(-1);

        // Current streak
        int currentStreak = 0;
        var checkDate = entryDates.Contains(today) ? today : yesterday;

        if (entryDates.Contains(today) || entryDates.Contains(yesterday))
        {
            while (entryDates.Contains(checkDate))
            {
                currentStreak++;
                checkDate = checkDate.AddDays(-1);
            }
        }
        analytics.CurrentStreak = currentStreak;

        // Longest streak
        int longestStreak = 0;
        int tempStreak = 1;
        var sortedDates = entryDates.OrderBy(d => d).ToList();

        for (int i = 1; i < sortedDates.Count; i++)
        {
            if ((sortedDates[i] - sortedDates[i - 1]).Days == 1)
            {
                tempStreak++;
            }
            else
            {
                longestStreak = Math.Max(longestStreak, tempStreak);
                tempStreak = 1;
            }
        }
        analytics.LongestStreak = Math.Max(longestStreak, tempStreak);
    }

    private string GetWeekLabel(DateTime date)
    {
        var weekStart = date.Date.AddDays(-(int)date.DayOfWeek);
        return weekStart.ToString("MMM d");
    }

    private string GetPeriodLabel()
    {
        return selectedPeriod switch
        {
            7 => "Last 7 days",
            30 => "Last 30 days",
            90 => "Last 90 days",
            365 => "This year",
            _ => "All time"
        };
    }

    private string CapitalizeFirst(string text)
    {
        if (string.IsNullOrEmpty(text)) return text;
        return char.ToUpper(text[0]) + text.Substring(1);
    }

    private string GetMoodInsightClass(string mood)
    {
        if (positiveMoods.Contains(mood)) return "positive";
        if (negativeMoods.Contains(mood)) return "negative";
        return "neutral";
    }

    private string GetMoodInsightText(string mood, int count, int total)
    {
        var percentage = total > 0 ? (int)(count * 100.0 / total) : 0;

        if (positiveMoods.Contains(mood))
            return $"{CapitalizeFirst(mood)} appears in {percentage}% of your entries. Keep up the positive energy!";
        if (negativeMoods.Contains(mood))
            return $"{CapitalizeFirst(mood)} appears in {percentage}% of your entries. Consider what might help improve your mood.";
        return $"{CapitalizeFirst(mood)} appears in {percentage}% of your entries.";
    }

    private async Task ExportReport()
    {
        try
        {
            var reportData = new AnalyticsReportData
            {
                PeriodLabel = GetPeriodLabel(),
                TotalEntries = analytics.TotalEntries,
                TotalWords = analytics.TotalWords,
                AverageWordsPerEntry = analytics.AverageWordsPerEntry,
                CurrentStreak = analytics.CurrentStreak,
                LongestStreak = analytics.LongestStreak,
                DaysJournaling = analytics.DaysJournaling,
                UniqueTags = analytics.UniqueTags,
                MoodCounts = analytics.MoodCounts,
                TopTags = analytics.TopTags
            };

            var filePath = await PdfExportService.ExportAnalyticsReportAsync(reportData);

            if (!string.IsNullOrEmpty(filePath))
            {
                await Application.Current!.MainPage!.DisplayAlert(
                    "Export Successful",
                    $"Your analytics report has been saved as PDF to:\n{filePath}",
                    "OK"
                );
            }
            else
            {
                await Application.Current!.MainPage!.DisplayAlert(
                    "Export Cancelled",
                    "The export was cancelled.",
                    "OK"
                );
            }
        }
        catch (Exception ex)
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", "Failed to export report: " + ex.Message, "OK");
        }
    }

    private string GenerateReportText()
    {
        var sb = new System.Text.StringBuilder();
        sb.AppendLine("=== Journal Analytics Report ===");
        sb.AppendLine($"Generated: {DateTime.Now:MMMM dd, yyyy}");
        sb.AppendLine($"Period: {GetPeriodLabel()}");
        sb.AppendLine();
        sb.AppendLine("--- Overview ---");
        sb.AppendLine($"Total Entries: {analytics.TotalEntries}");
        sb.AppendLine($"Current Streak: {analytics.CurrentStreak} days");
        sb.AppendLine($"Longest Streak: {analytics.LongestStreak} days");
        sb.AppendLine($"Average Words/Entry: {analytics.AverageWordsPerEntry:F0}");
        sb.AppendLine($"Total Words Written: {analytics.TotalWords:N0}");
        sb.AppendLine();
        sb.AppendLine("--- Mood Distribution ---");
        foreach (var mood in analytics.MoodCounts.OrderByDescending(m => m.Value))
        {
            sb.AppendLine($"{CapitalizeFirst(mood.Key)}: {mood.Value}");
        }
        return sb.ToString();
    }

    // Analytics data class
    private class AnalyticsData
    {
        public int TotalEntries { get; set; }
        public int TotalWords { get; set; }
        public double AverageWordsPerEntry { get; set; }
        public int CurrentStreak { get; set; }
        public int LongestStreak { get; set; }
        public int CompletionRate { get; set; }
        public int DaysJournaling { get; set; }
        public int UniqueTags { get; set; }
        public int UniqueCategories { get; set; }
        public int WordCountGrowth { get; set; }

        public int PositiveMoodPercentage { get; set; }
        public int NeutralMoodPercentage { get; set; }
        public int NegativeMoodPercentage { get; set; }

        public string MostCommonMood { get; set; } = "";
        public string MostActiveTimeSlot { get; set; } = "";

        public Dictionary<string, int> MoodCounts { get; set; } = new();
        public Dictionary<string, int> CategoryCounts { get; set; } = new();
        public Dictionary<string, int> WeeklyFrequency { get; set; } = new();
        public Dictionary<string, int> WordCountTrend { get; set; } = new();
        public Dictionary<string, int> TimeDistribution { get; set; } = new();
        public List<TagUsageDisplayModel> TopTags { get; set; } = new();
    }
}