@page "/"
@page "/today"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using PersonalJournalApp.Models.Input
@using PersonalJournalApp.Services
@using PersonalJournalApp.Auth
@using PersonalJournalApp.Components.Shared
@using PersonalJournalApp.Data
@using PersonalJournalApp.Entities
@inject AuthenticationStateProvider AuthStateProvider
@inject CustomAuthStateProvider CustomAuthStateProvider
@inject NavigationManager Navigation
@inject JournalService JournalService
@inject CategoryService CategoryService
@inject TagService TagService
@inject AppDbContext DbContext

@if (!isAuthorized)
{
    <p>Redirecting...</p>
}
else
{
    <div class="page-content @(isFullscreen ? "fullscreen-mode" : "")">
        @if (!isFullscreen)
        {
            <div class="page-header">
                <div class="header-left">
                    <h1>Today's Entry</h1>
                    <p class="page-subtitle">
                        <svg class="subtitle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        @DateTime.Now.ToString("dddd, MMMM d, yyyy")
                    </p>
                </div>
                <div class="header-actions">
                    @if (todayEntryId.HasValue)
                    {
                        <button class="btn btn-danger" @onclick="DeleteEntry">
                            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Delete
                        </button>
                    }
                    <button class="btn btn-primary" @onclick="SaveEntry" disabled="@isSaving">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        @(isSaving ? "Saving..." : "Save Entry")
                    </button>
                </div>
            </div>
        }

        <div class="editor-layout">
            @if (!isFullscreen)
            {
                <!-- Left: Meta Panel -->
                <aside class="meta-panel">
                    <!-- Primary Mood Selection -->
                    <div class="meta-card">
                        <div class="meta-header">
                            <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                            <span>Primary Mood (Required)</span>
                        </div>
                        <div class="mood-categories">
                            @foreach (var category in moodsByCategory)
                            {
                                <div class="mood-category-section">
                                    <div class="mood-category-label">@category.Key</div>
                                    <div class="mood-grid">
                                        @foreach (var mood in category.Value)
                                        {
                                            <button class="mood-btn @(entryModel.PrimaryMood == mood.Value ? "active" : "")"
                                                    @onclick="() => entryModel.PrimaryMood = mood.Value">
                                                <svg class="mood-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    @((MarkupString)GetMoodIconPath(mood.Value))
                                                </svg>
                                                <span class="mood-label">@mood.Label</span>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Secondary Moods Selection -->
                    <div class="meta-card">
                        <div class="meta-header">
                            <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="8" y1="15" x2="16" y2="15"></line>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                            <span>Secondary Moods (Optional - up to 2)</span>
                        </div>
                        <div class="secondary-moods-list">
                            @foreach (var category in moodsByCategory)
                            {
                                @foreach (var mood in category.Value)
                                {
                                    @if (mood.Value != entryModel.PrimaryMood)
                                    {
                                        <label class="mood-checkbox">
                                            <input type="checkbox"
                                                   checked="@(secondaryMoods.Contains(mood.Value))"
                                                   @onchange="e => ToggleSecondaryMood(mood.Value, (bool)e.Value!)"
                                                   disabled="@(secondaryMoods.Count >= 2 && !secondaryMoods.Contains(mood.Value))" />
                                            <span class="mood-checkbox-label">@mood.Label</span>
                                        </label>
                                    }
                                }
                            }
                        </div>
                    </div>

                    <!-- Category Selection -->
                    <div class="meta-card">
                        <div class="meta-header">
                            <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span>Category</span>
                        </div>
                        <select class="form-select" @bind="entryModel.CategoryId">
                            <option value="">No Category</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                    </div>

                    <!-- Tags Selection -->
                    <div class="meta-card">
                        <div class="meta-header">
                            <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                <line x1="7" y1="7" x2="7.01" y2="7"></line>
                            </svg>
                            <span>Tags</span>
                        </div>

                        <!-- Pre-built Tags -->
                        <div class="tags-section">
                            <div class="tags-section-label">Pre-built Tags</div>
                            <div class="tags-list">
                                @foreach (var tag in prebuiltTags)
                                {
                                    <label class="tag-checkbox">
                                        <input type="checkbox"
                                               checked="@entryModel.SelectedTagIds.Contains(tag.Id)"
                                               @onchange="e => ToggleTag(tag.Id, (bool)e.Value!)" />
                                        <span class="tag-label">@tag.Name</span>
                                    </label>
                                }
                            </div>
                        </div>

                        <!-- Custom Tags -->
                        @if (customTags.Any())
                        {
                            <div class="tags-section">
                                <div class="tags-section-label">Custom Tags</div>
                                <div class="tags-list">
                                    @foreach (var tag in customTags)
                                    {
                                        <label class="tag-checkbox">
                                            <input type="checkbox"
                                                   checked="@entryModel.SelectedTagIds.Contains(tag.Id)"
                                                   @onchange="e => ToggleTag(tag.Id, (bool)e.Value!)" />
                                            <span class="tag-label">@tag.Name</span>
                                        </label>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </aside>
            }

            <!-- Right: Editor -->
            <div class="editor-section">
                <div class="editor-card">
                    <button class="fullscreen-toggle" @onclick="ToggleFullscreen" title="@(isFullscreen ? "Exit Fullscreen" : "Enter Fullscreen")">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            @if (isFullscreen)
                            {
                                <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                            }
                            else
                            {
                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                            }
                        </svg>
                    </button>

                    <div class="editor-header">
                        <input type="text"
                               class="entry-title"
                               placeholder="Entry title (optional)..."
                               @bind="entryModel.Title"
                               @bind:event="oninput" />
                    </div>

                    <div class="editor-body">
                        <RichTextEditor EditorId="todayEditor"
                                        InitialContent="@entryModel.Content"
                                        Placeholder="What's on your mind today?"
                                        OnContentChange="HandleContentChange"
                                        OnWordCountChange="HandleWordCountChange" />
                    </div>

                    <div class="editor-footer">
                        <div class="word-count">
                            <svg class="footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="4 7 4 4 20 4 20 7"></polyline>
                                <line x1="9" y1="20" x2="15" y2="20"></line>
                                <line x1="12" y1="4" x2="12" y2="20"></line>
                            </svg>
                            @wordCount words • @characterCount characters
                        </div>
                        @if (!isFullscreen)
                        {
                            <div class="save-status">
                                @if (lastSaved.HasValue)
                                {
                                    <svg class="footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    <span>Saved @lastSaved.Value.ToString("h:mm tt")</span>
                                }
                            </div>
                        }
                        else
                        {
                            <button class="btn btn-primary" @onclick="SaveEntry" disabled="@isSaving">
                                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                    <polyline points="7 3 7 8 15 8"></polyline>
                                </svg>
                                @(isSaving ? "Saving..." : "Save Entry")
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthorized = false;
    private bool isFullscreen = false;
    private bool isSaving = false;
    private int wordCount = 0;
    private int characterCount = 0;
    private DateTime? lastSaved;
    private string? currentUserId;

    private JournalEntryInputModel entryModel = new();
    private List<PersonalJournalApp.Entities.Category> categories = new();
    private List<PersonalJournalApp.Entities.Tag> prebuiltTags = new();
    private List<PersonalJournalApp.Entities.Tag> customTags = new();
    private List<string> secondaryMoods = new();
    private int? todayEntryId = null;

    private Dictionary<string, List<(string Value, string Label)>> moodsByCategory = new()
    {
        {
            "Positive", new List<(string, string)>
            {
                ("happy", "Happy"),
                ("excited", "Excited"),
                ("relaxed", "Relaxed"),
                ("grateful", "Grateful"),
                ("confident", "Confident")
            }
        },
        {
            "Neutral", new List<(string, string)>
            {
                ("calm", "Calm"),
                ("thoughtful", "Thoughtful"),
                ("curious", "Curious"),
                ("nostalgic", "Nostalgic"),
                ("bored", "Bored")
            }
        },
        {
            "Negative", new List<(string, string)>
            {
                ("sad", "Sad"),
                ("angry", "Angry"),
                ("stressed", "Stressed"),
                ("lonely", "Lonely"),
                ("anxious", "Anxious")
            }
        }
    };

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
        if (userIdClaim == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        currentUserId = userIdClaim.Value;

        // handle the case where the database was recreated but old userId is in Preferences
        var userExists = await DbContext.Users.AnyAsync(u => u.Id == currentUserId);
        if (!userExists)
        {
            // User doesn't exist in database - clear auth and redirect to login
            await CustomAuthStateProvider.MarkUserAsLoggedOut();
            Navigation.NavigateTo("/login");
            return;
        }

        // Load categories
        var categoriesResult = await CategoryService.GetAllCategoriesAsync(currentUserId);
        if (categoriesResult.Success && categoriesResult.Data != null)
        {
            categories = categoriesResult.Data;

            // Seed default categories if none exist
            if (categories.Count == 0)
            {
                try
                {
                    var defaultCategories = new[] { "Personal", "Work", "Health", "Travel", "Goals" };
                    foreach (var categoryName in defaultCategories)
                    {
                        await CategoryService.CreateCategoryAsync(currentUserId, new CategoryInputModel { Name = categoryName });
                    }
                    // Reload categories after seeding
                    categoriesResult = await CategoryService.GetAllCategoriesAsync(currentUserId);
                    if (categoriesResult.Success && categoriesResult.Data != null)
                    {
                        categories = categoriesResult.Data;
                    }
                }
                catch (Exception ex)
                {
                    // Log or handle the error gracefully
                    Console.WriteLine($"Failed to seed categories: {ex.Message}");
                }
            }
        }

        // Load tags and separate pre-built from custom
        var tagsResult = await TagService.GetAllTagsAsync(currentUserId);
        if (tagsResult.Success && tagsResult.Data != null)
        {
            var allTags = tagsResult.Data;

            // Seed pre-built tags if none exist
            if (!allTags.Any(t => t.IsPrebuilt))
            {
                try
                {
                    await TagSeeder.SeedTagsForUserAsync(DbContext, currentUserId);
                    // Reload tags after seeding
                    tagsResult = await TagService.GetAllTagsAsync(currentUserId);
                    if (tagsResult.Success && tagsResult.Data != null)
                    {
                        allTags = tagsResult.Data;
                    }
                }
                catch (Exception ex)
                {
                    // Log or handle the error gracefully
                    Console.WriteLine($"Failed to seed tags: {ex.Message}");
                }
            }

            prebuiltTags = allTags.Where(t => t.IsPrebuilt).OrderBy(t => t.Name).ToList();
            customTags = allTags.Where(t => !t.IsPrebuilt).OrderBy(t => t.Name).ToList();
        }

        // Load today's entry
        await LoadTodaysEntryAsync();

        isAuthorized = true;
    }

    private async Task LoadTodaysEntryAsync()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;

        var today = DateTime.UtcNow.Date;
        var result = await JournalService.GetEntriesByDateRangeAsync(currentUserId, today, today);

        if (result.Success && result.Data != null && result.Data.Any())
        {
            var todaysEntry = result.Data.First();
            todayEntryId = todaysEntry.Id;
            entryModel.Title = todaysEntry.Title;
            entryModel.Content = todaysEntry.Content;
            entryModel.PrimaryMood = todaysEntry.PrimaryMood;
            entryModel.SecondaryMood1 = todaysEntry.SecondaryMood1;
            entryModel.SecondaryMood2 = todaysEntry.SecondaryMood2;

            // Load the category ID if exists
            var fullEntry = await DbContext.JournalEntries
                .Include(e => e.Category)
                .Include(e => e.Tags)
                .FirstOrDefaultAsync(e => e.Id == todaysEntry.Id);

            if (fullEntry != null)
            {
                entryModel.CategoryId = fullEntry.CategoryId;
                entryModel.SelectedTagIds = fullEntry.Tags.Select(t => t.Id).ToList();
            }

            // Populate secondary moods list
            secondaryMoods.Clear();
            if (!string.IsNullOrEmpty(todaysEntry.SecondaryMood1))
                secondaryMoods.Add(todaysEntry.SecondaryMood1);
            if (!string.IsNullOrEmpty(todaysEntry.SecondaryMood2))
                secondaryMoods.Add(todaysEntry.SecondaryMood2);

            // Calculate word count
            wordCount = todaysEntry.WordCount;
            characterCount = todaysEntry.Content.Length;
        }
        else
        {
            // No entry for today - initialize with default values
            entryModel = new JournalEntryInputModel { PrimaryMood = "calm" };
            secondaryMoods.Clear();
            todayEntryId = null;
            wordCount = 0;
            characterCount = 0;
        }

        isAuthorized = true;
    }

    private void ToggleFullscreen()
    {
        isFullscreen = !isFullscreen;
    }

    private void HandleContentChange(string htmlContent)
    {
        entryModel.Content = htmlContent;
        characterCount = htmlContent.Length;
    }

    private void HandleWordCountChange(int count)
    {
        wordCount = count;
    }

    private void ToggleTag(int tagId, bool isChecked)
    {
        if (isChecked)
        {
            if (!entryModel.SelectedTagIds.Contains(tagId))
                entryModel.SelectedTagIds.Add(tagId);
        }
        else
        {
            entryModel.SelectedTagIds.Remove(tagId);
        }
    }

    private void ToggleSecondaryMood(string moodValue, bool isChecked)
    {
        if (isChecked)
        {
            if (secondaryMoods.Count < 2 && !secondaryMoods.Contains(moodValue))
            {
                secondaryMoods.Add(moodValue);
            }
        }
        else
        {
            secondaryMoods.Remove(moodValue);
        }

        // Update model
        entryModel.SecondaryMood1 = secondaryMoods.Count > 0 ? secondaryMoods[0] : null;
        entryModel.SecondaryMood2 = secondaryMoods.Count > 1 ? secondaryMoods[1] : null;
    }

    private async Task SaveEntry()
    {
        if (string.IsNullOrWhiteSpace(entryModel.Content))
        {
            await Application.Current!.MainPage!.DisplayAlert("Validation Error", "Please write some content for your entry.", "OK");
            return;
        }

        isSaving = true;
        var userId = CustomAuthStateProvider.GetCurrentUserId();

        try
        {
            Common.ServiceResult result;

            if (todayEntryId.HasValue)
            {
                // Update existing entry
                result = await JournalService.UpdateEntryAsync(userId!, todayEntryId.Value, entryModel);
            }
            else
            {
                // Create new entry
                var createResult = await JournalService.CreateEntryAsync(userId!, entryModel);
                result = createResult;
                if (createResult.Success)
                {
                    todayEntryId = createResult.Data;
                }
            }

            if (result.Success)
            {
                lastSaved = DateTime.Now;
                await Application.Current!.MainPage!.DisplayAlert("Success", "Entry saved successfully!", "OK");
            }
            else
            {
                await Application.Current!.MainPage!.DisplayAlert("Error", result.ErrorMessage ?? "Failed to save entry.", "OK");
            }
        }
        catch (Exception ex)
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", $"An error occurred: {ex.Message}", "OK");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteEntry()
    {
        if (!todayEntryId.HasValue) return;

        bool confirmed = await Application.Current!.MainPage!.DisplayAlert(
            "Confirm Delete",
            "Are you sure you want to delete today's entry? This action cannot be undone.",
            "Delete",
            "Cancel"
        );

        if (!confirmed) return;

        var userId = CustomAuthStateProvider.GetCurrentUserId();
        var result = await JournalService.DeleteEntryAsync(userId!, todayEntryId.Value);

        if (result.Success)
        {
            await Application.Current!.MainPage!.DisplayAlert("Success", "Entry deleted successfully.", "OK");

            // Clear the form
            todayEntryId = null;
            entryModel = new() { PrimaryMood = "calm" };
            secondaryMoods.Clear();
            wordCount = 0;
            characterCount = 0;
            lastSaved = null;
        }
        else
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", result.ErrorMessage ?? "Failed to delete entry.", "OK");
        }
    }

    private string GetMoodIconPath(string moodValue)
    {
        return moodValue switch
        {
            "happy" => @"<circle cx=""12"" cy=""12"" r=""10""></circle><path d=""M8 14s1.5 2 4 2 4-2 4-2""></path><line x1=""9"" y1=""9"" x2=""9.01"" y2=""9""></line><line x1=""15"" y1=""9"" x2=""15.01"" y2=""9""></line>",
            "sad" => @"<circle cx=""12"" cy=""12"" r=""10""></circle><path d=""M16 16s-1.5-2-4-2-4 2-4 2""></path><line x1=""9"" y1=""9"" x2=""9.01"" y2=""9""></line><line x1=""15"" y1=""9"" x2=""15.01"" y2=""9""></line>",
            "calm" => @"<circle cx=""12"" cy=""12"" r=""10""></circle><line x1=""8"" y1=""15"" x2=""16"" y2=""15""></line><line x1=""9"" y1=""9"" x2=""9.01"" y2=""9""></line><line x1=""15"" y1=""9"" x2=""15.01"" y2=""9""></line>",
            "anxious" => @"<circle cx=""12"" cy=""12"" r=""10""></circle><path d=""M8 15h8""></path><line x1=""9"" y1=""9"" x2=""9.01"" y2=""9""></line><line x1=""15"" y1=""9"" x2=""15.01"" y2=""9""></line>",
            "excited" => @"<circle cx=""12"" cy=""12"" r=""10""></circle><path d=""M8 14s1.5 2 4 2 4-2 4-2""></path><circle cx=""9"" cy=""9"" r=""1""></circle><circle cx=""15"" cy=""9"" r=""1""></circle>",
            "stressed" => @"<circle cx=""12"" cy=""12"" r=""10""></circle><line x1=""8"" y1=""15"" x2=""16"" y2=""15""></line><line x1=""7"" y1=""9"" x2=""11"" y2=""9""></line><line x1=""13"" y1=""9"" x2=""17"" y2=""9""></line>",
            _ => @"<circle cx=""12"" cy=""12"" r=""10""></circle><line x1=""8"" y1=""15"" x2=""16"" y2=""15""></line><line x1=""9"" y1=""9"" x2=""9.01"" y2=""9""></line><line x1=""15"" y1=""9"" x2=""15.01"" y2=""9""></line>"
        };
    }
}