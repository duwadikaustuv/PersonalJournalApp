@page "/"
@page "/today"
@using Microsoft.AspNetCore.Components.Authorization
@using PersonalJournalApp.Models.Input
@using PersonalJournalApp.Services
@using PersonalJournalApp.Auth
@using PersonalJournalApp.Components.Shared
@inject AuthenticationStateProvider AuthStateProvider
@inject CustomAuthStateProvider CustomAuthStateProvider
@inject NavigationManager Navigation
@inject JournalService JournalService
@inject CategoryService CategoryService
@inject TagService TagService

@if (!isAuthorized)
{
    <p>Redirecting...</p>
}
else
{
    <div class="page-content @(isFullscreen ? "fullscreen-mode" : "")">
        @if (!isFullscreen)
        {
            <div class="page-header">
                <div class="header-left">
                    <h1>Today's Entry</h1>
                    <p class="page-subtitle">
                        <svg class="subtitle-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        @DateTime.Now.ToString("dddd, MMMM d, yyyy")
                    </p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" @onclick="SaveEntry" disabled="@isSaving">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                            <polyline points="17 21 17 13 7 13 7 21"></polyline>
                            <polyline points="7 3 7 8 15 8"></polyline>
                        </svg>
                        @(isSaving ? "Saving..." : "Save Entry")
                    </button>
                </div>
            </div>
        }

        <div class="editor-layout">
            @if (!isFullscreen)
            {
                <!-- Left: Meta Panel -->
                <aside class="meta-panel">
                    <!-- Mood Selection -->
                    <div class="meta-card">
                        <div class="meta-header">
                            <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                <line x1="15" y1="9" x2="15.01" y2="9"></line>
                            </svg>
                            <span>How are you feeling?</span>
                        </div>
                        <div class="mood-grid">
                            @foreach (var mood in moods)
                            {
                                <button class="mood-btn @(entryModel.Mood == mood.Value ? "active" : "")"
                                        @onclick="() => entryModel.Mood = mood.Value">
                                    <svg class="mood-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        @if (mood.Value == "happy")
                                        {
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                        }
                                        else if (mood.Value == "sad")
                                        {
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M16 16s-1.5-2-4-2-4 2-4 2"></path>
                                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                        }
                                        else if (mood.Value == "calm")
                                        {
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="8" y1="15" x2="16" y2="15"></line>
                                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                        }
                                        else if (mood.Value == "anxious")
                                        {
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M8 15h8"></path>
                                            <line x1="9" y1="9" x2="9.01" y2="9"></line>
                                            <line x1="15" y1="9" x2="15.01" y2="9"></line>
                                        }
                                        else if (mood.Value == "excited")
                                        {
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <path d="M8 14s1.5 2 4 2 4-2 4-2"></path>
                                            <circle cx="9" cy="9" r="1"></circle>
                                            <circle cx="15" cy="9" r="1"></circle>
                                        }
                                        else if (mood.Value == "tired")
                                        {
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <line x1="8" y1="15" x2="16" y2="15"></line>
                                            <line x1="7" y1="9" x2="11" y2="9"></line>
                                            <line x1="13" y1="9" x2="17" y2="9"></line>
                                        }
                                    </svg>
                                    <span class="mood-label">@mood.Label</span>
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Category Selection -->
                    <div class="meta-card">
                        <div class="meta-header">
                            <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <span>Category</span>
                        </div>
                        <select class="form-select" @bind="entryModel.CategoryId">
                            <option value="">No Category</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id">@category.Name</option>
                            }
                        </select>
                    </div>

                    <!-- Tags Selection -->
                    <div class="meta-card">
                        <div class="meta-header">
                            <svg class="meta-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                <line x1="7" y1="7" x2="7.01" y2="7"></line>
                            </svg>
                            <span>Tags</span>
                        </div>
                        <div class="tags-list">
                            @foreach (var tag in tags)
                            {
                                <label class="tag-checkbox">
                                    <input type="checkbox"
                                           checked="@entryModel.SelectedTagIds.Contains(tag.Id)"
                                           @onchange="e => ToggleTag(tag.Id, (bool)e.Value!)" />
                                    <span class="tag-label">@tag.Name</span>
                                </label>
                            }
                        </div>
                    </div>
                </aside>
            }

            <!-- Right: Editor -->
            <div class="editor-section">
                <div class="editor-card">
                    <button class="fullscreen-toggle" @onclick="ToggleFullscreen" title="@(isFullscreen ? "Exit Fullscreen" : "Enter Fullscreen")">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            @if (isFullscreen)
                            {
                                <path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path>
                            }
                            else
                            {
                                <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
                            }
                        </svg>
                    </button>

                    <div class="editor-header">
                        <input type="text"
                               class="entry-title"
                               placeholder="Entry title..."
                               @bind="entryModel.Title"
                               @bind:event="oninput" />
                    </div>

                    <div class="editor-body">
                        <RichTextEditor EditorId="todayEditor"
                                        InitialContent="@entryModel.Content"
                                        Placeholder="What's on your mind today?"
                                        OnContentChange="HandleContentChange"
                                        OnWordCountChange="HandleWordCountChange" />
                    </div>

                    <div class="editor-footer">
                        <div class="word-count">
                            <svg class="footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="4 7 4 4 20 4 20 7"></polyline>
                                <line x1="9" y1="20" x2="15" y2="20"></line>
                                <line x1="12" y1="4" x2="12" y2="20"></line>
                            </svg>
                            @wordCount words • @characterCount characters
                        </div>
                        @if (!isFullscreen)
                        {
                            <div class="save-status">
                                @if (lastSaved.HasValue)
                                {
                                    <svg class="footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    <span>Saved @lastSaved.Value.ToString("h:mm tt")</span>
                                }
                            </div>
                        }
                        else
                        {
                            <button class="btn btn-primary" @onclick="SaveEntry" disabled="@isSaving">
                                <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                    <polyline points="7 3 7 8 15 8"></polyline>
                                </svg>
                                @(isSaving ? "Saving..." : "Save Entry")
                            </button>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthorized = false;
    private bool isFullscreen = false;
    private bool isSaving = false;
    private int wordCount = 0;
    private int characterCount = 0;
    private DateTime? lastSaved;

    private JournalEntryInputModel entryModel = new();
    private List<PersonalJournalApp.Entities.Category> categories = new();
    private List<PersonalJournalApp.Entities.Tag> tags = new();
    private int? todayEntryId = null;

    private List<(string Value, string Label)> moods = new()
    {
        ("happy", "Happy"),
        ("sad", "Sad"),
        ("calm", "Calm"),
        ("anxious", "Anxious"),
        ("excited", "Excited"),
        ("tired", "Tired")
    };

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/login");
        }
        else
        {
            isAuthorized = true;
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        var userId = CustomAuthStateProvider.GetCurrentUserId();
        if (string.IsNullOrEmpty(userId)) return;

        // Load categories and tags
        var categoriesResult = await CategoryService.GetAllCategoriesAsync(userId);
        if (categoriesResult.Success && categoriesResult.Data != null)
        {
            categories = categoriesResult.Data;
        }

        var tagsResult = await TagService.GetAllTagsAsync(userId);
        if (tagsResult.Success && tagsResult.Data != null)
        {
            tags = tagsResult.Data;
        }

        // Load today's entry if exists
        var today = DateTime.Today;
        var entryResult = await JournalService.GetEntriesByDateRangeAsync(userId, today, today);
        if (entryResult.Success && entryResult.Data != null && entryResult.Data.Any())
        {
            var todayEntry = entryResult.Data.First();
            todayEntryId = todayEntry.Id;

            entryModel.Title = todayEntry.Title;
            entryModel.Content = todayEntry.Content;
            entryModel.Mood = todayEntry.Mood;
            entryModel.CategoryId = todayEntry.CategoryName != null ?
                categories.FirstOrDefault(c => c.Name == todayEntry.CategoryName)?.Id : null;
            entryModel.SelectedTagIds = tags
                .Where(t => todayEntry.TagNames.Contains(t.Name))
                .Select(t => t.Id)
                .ToList();
        }
        else
        {
            entryModel.Mood = "calm";
        }
    }

    private void ToggleFullscreen()
    {
        isFullscreen = !isFullscreen;
    }

    private void HandleContentChange(string htmlContent)
    {
        entryModel.Content = htmlContent;
        characterCount = htmlContent.Length;
    }

    private void HandleWordCountChange(int count)
    {
        wordCount = count;
    }

    private void ToggleTag(int tagId, bool isChecked)
    {
        if (isChecked)
        {
            if (!entryModel.SelectedTagIds.Contains(tagId))
                entryModel.SelectedTagIds.Add(tagId);
        }
        else
        {
            entryModel.SelectedTagIds.Remove(tagId);
        }
    }

    private async Task SaveEntry()
    {
        if (string.IsNullOrWhiteSpace(entryModel.Title))
        {
            await Application.Current!.MainPage!.DisplayAlert("Validation Error", "Please enter a title for your entry.", "OK");
            return;
        }

        if (string.IsNullOrWhiteSpace(entryModel.Content))
        {
            await Application.Current!.MainPage!.DisplayAlert("Validation Error", "Please write some content for your entry.", "OK");
            return;
        }

        isSaving = true;
        var userId = CustomAuthStateProvider.GetCurrentUserId();

        try
        {
            Common.ServiceResult result;

            if (todayEntryId.HasValue)
            {
                // Update existing entry
                result = await JournalService.UpdateEntryAsync(userId!, todayEntryId.Value, entryModel);
            }
            else
            {
                // Create new entry
                var createResult = await JournalService.CreateEntryAsync(userId!, entryModel);
                result = createResult;
                if (createResult.Success)
                {
                    todayEntryId = createResult.Data;
                }
            }

            if (result.Success)
            {
                lastSaved = DateTime.Now;
                await Application.Current!.MainPage!.DisplayAlert("Success", "Entry saved successfully!", "OK");
            }
            else
            {
                await Application.Current!.MainPage!.DisplayAlert("Error", result.ErrorMessage ?? "Failed to save entry.", "OK");
            }
        }
        catch (Exception ex)
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", $"An error occurred: {ex.Message}", "OK");
        }
        finally
        {
            isSaving = false;
        }
    }
}