@page "/settings"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using PersonalJournalApp.Services
@using PersonalJournalApp.Auth
@using PersonalJournalApp.Data
@using PersonalJournalApp.Models.Input
@inject AuthenticationStateProvider AuthStateProvider
@inject CustomAuthStateProvider CustomAuthStateProvider
@inject NavigationManager Navigation
@inject ThemeService ThemeService
@inject AppLockService AppLockService
@inject SettingsService SettingsService
@inject TagService TagService
@inject CategoryService CategoryService
@inject AppDbContext DbContext

@if (!isAuthorized)
{
    <p>Redirecting...</p>
}
else
{
    <div class="page-content">
        <div class="page-header">
            <h1>Settings</h1>
            <p class="page-subtitle">Manage your preferences and data</p>
        </div>

        <div class="settings-container">
            <!-- Security Section -->
            <div class="settings-section">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                    </svg>
                    <h2>Security & Privacy</h2>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <label>App Lock</label>
                        <p>Require PIN to open your journal</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox"
                               checked="@isAppLockEnabled"
                               @onclick="OnAppLockToggleClicked"
                               disabled="@(!hasPinSet)" />
                        <span class="slider"></span>
                    </label>
                </div>

                @if (!hasPinSet)
                {
                    <div class="info-banner">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span>Set a PIN first to enable App Lock</span>
                    </div>
                }

                <div class="setting-item">
                    <div class="setting-info">
                        <label>@(hasPinSet ? "Change PIN" : "Set PIN")</label>
                        <p>@(hasPinSet ? "Update your security PIN" : "Create a PIN to protect your journal")</p>
                    </div>
                    <button class="btn-secondary-sm" @onclick="OpenPinModal">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                        @(hasPinSet ? "Change" : "Set PIN")
                    </button>
                </div>

                @if (hasPinSet)
                {
                    <div class="setting-item">
                        <div class="setting-info">
                            <label>Remove PIN</label>
                            <p>Disable PIN protection completely</p>
                        </div>
                        <button class="btn-danger-sm" @onclick="RemovePin">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                            Remove
                        </button>
                    </div>
                }
            </div>

            <!-- Appearance Section -->
            <div class="settings-section">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <h2>Appearance</h2>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <label>Theme</label>
                        <p>Choose your preferred color scheme</p>
                    </div>
                    <div class="theme-selector">
                        <button class="theme-option @(currentTheme == "Light" ? "active" : "")" @onclick='() => SetTheme("Light")'>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5"></circle>
                                <line x1="12" y1="1" x2="12" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="23"></line>
                            </svg>
                            Light
                        </button>
                        <button class="theme-option @(currentTheme == "Dark" ? "active" : "")" @onclick='() => SetTheme("Dark")'>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                            </svg>
                            Dark
                        </button>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <label>Font Size</label>
                        <p>Adjust text size for comfortable reading</p>
                    </div>
                    <select class="select-input" value="@currentFontSize" @onchange="OnFontSizeChanged">
                        <option value="Small">Small</option>
                        <option value="Medium">Medium</option>
                        <option value="Large">Large</option>
                    </select>
                </div>
            </div>

            <!-- Tags & Categories Section -->
            <div class="settings-section">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                        <line x1="7" y1="7" x2="7.01" y2="7"></line>
                    </svg>
                    <h2>Tags & Categories</h2>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <label>Custom Tags</label>
                        <p>You have @customTags.Count custom tags</p>
                    </div>
                    <button class="btn-secondary-sm" @onclick="ToggleTagManagement">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Manage
                    </button>
                </div>

                @if (showTagManagement)
                {
                    <div class="tag-management">
                        <div class="add-tag-form">
                            <input type="text" class="tag-input" placeholder="New tag name..." @bind="newTagName" @bind:event="oninput" />
                            <button class="btn-add-tag" @onclick="AddCustomTag" disabled="@string.IsNullOrWhiteSpace(newTagName)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="tag-list">
                            @foreach (var tag in customTags)
                            {
                                <div class="tag-item">
                                    <span class="tag">@tag.Name</span>
                                    <button class="tag-delete" @onclick="() => DeleteTag(tag.Id)">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            }
                            @if (customTags.Count == 0)
                            {
                                <p class="no-tags">No custom tags yet. Add one above!</p>
                            }
                        </div>
                    </div>
                }

                <div class="setting-item">
                    <div class="setting-info">
                        <label>Categories</label>
                        <p>You have @categories.Count categories</p>
                    </div>
                    <button class="btn-secondary-sm" @onclick="ToggleCategoryManagement">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                        </svg>
                        Manage
                    </button>
                </div>

                @if (showCategoryManagement)
                {
                    <div class="tag-management">
                        <div class="add-tag-form">
                            <input type="text" class="tag-input" placeholder="New category name..." @bind="newCategoryName" @bind:event="oninput" />
                            <button class="btn-add-tag" @onclick="AddCategory" disabled="@string.IsNullOrWhiteSpace(newCategoryName)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19"></line>
                                    <line x1="5" y1="12" x2="19" y2="12"></line>
                                </svg>
                            </button>
                        </div>
                        <div class="tag-list">
                            @foreach (var category in categories)
                            {
                                <div class="tag-item">
                                    <span class="tag category-tag">@category.Name</span>
                                    <button class="tag-delete" @onclick="() => DeleteCategory(category.Id)">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            }
                            @if (categories.Count == 0)
                            {
                                <p class="no-tags">No categories yet. Add one above!</p>
                            }
                        </div>
                    </div>
                }
            </div>

            <!-- Account Section -->
            <div class="settings-section">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                    <h2>Account</h2>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <label>Logged in as</label>
                        <p>@currentUserEmail</p>
                    </div>
                </div>

                <div class="setting-item">
                    <div class="setting-info">
                        <label>Total Entries</label>
                        <p>@totalEntries journal entries</p>
                    </div>
                </div>

                <div class="setting-item danger">
                    <div class="setting-info">
                        <label>Logout</label>
                        <p>Sign out from your account</p>
                    </div>
                    <button class="btn-secondary-sm" @onclick="Logout">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                        Logout
                    </button>
                </div>
            </div>

            <!-- About Section -->
            <div class="settings-section">
                <div class="section-header">
                    <svg class="section-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <h2>About</h2>
                </div>

                <div class="about-info">
                    <div class="info-row">
                        <span class="info-label">Version</span>
                        <span class="info-value">1.0.0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Build Date</span>
                        <span class="info-value">January 2026</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Framework</span>
                        <span class="info-value">.NET MAUI 9.0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

<!-- PIN Modal -->
@if (showPinModal)
{
    <div class="modal-overlay" @onclick="ClosePinModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>@(hasPinSet ? "Change PIN" : "Set PIN")</h3>
                <button class="modal-close" @onclick="ClosePinModal">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                @if (!string.IsNullOrEmpty(pinError))
                {
                    <div class="pin-error">@pinError</div>
                }

                @if (hasPinSet && pinStep == 1)
                {
                    <label class="pin-label">Enter Current PIN</label>
                    <input type="password" class="pin-input" maxlength="6" @bind="currentPinInput" placeholder="••••••" />
                }

                @if (pinStep == 2 || (!hasPinSet && pinStep == 1))
                {
                    <label class="pin-label">Enter New PIN (4-6 digits)</label>
                    <input type="password" class="pin-input" maxlength="6" @bind="newPinInput" placeholder="••••••" />
                }

                @if (pinStep == 3 || (!hasPinSet && pinStep == 2))
                {
                    <label class="pin-label">Confirm New PIN</label>
                    <input type="password" class="pin-input" maxlength="6" @bind="confirmPinInput" placeholder="••••••" />
                }
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="ClosePinModal">Cancel</button>
                <button class="btn-primary" @onclick="ProcessPinStep" disabled="@isProcessingPin">
                    @if (isProcessingPin)
                    {
                        <span>Processing...</span>
                    }
                    else
                    {
                        <span>@GetPinButtonText()</span>
                    }
                </button>
            </div>
        </div>
    </div>
}

@code {
    private bool isAuthorized = false;
    private string? currentUserId;
    private string currentUserEmail = "";
    private int totalEntries = 0;

    // Theme settings
    private string currentTheme = "Light";
    private string currentFontSize = "Medium";

    // Security settings
    private bool isAppLockEnabled = false;
    private bool hasPinSet = false;

    // Tag/Category management
    private bool showTagManagement = false;
    private bool showCategoryManagement = false;
    private string newTagName = "";
    private string newCategoryName = "";
    private List<PersonalJournalApp.Entities.Tag> customTags = new();
    private List<PersonalJournalApp.Entities.Category> categories = new();

    // PIN Modal
    private bool showPinModal = false;
    private int pinStep = 1;
    private string currentPinInput = "";
    private string newPinInput = "";
    private string confirmPinInput = "";
    private string pinError = "";
    private bool isProcessingPin = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        currentUserId = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
        if (string.IsNullOrEmpty(currentUserId))
        {
            currentUserId = CustomAuthStateProvider.GetCurrentUserId();
        }

        if (string.IsNullOrEmpty(currentUserId))
        {
            Navigation.NavigateTo("/login");
            return;
        }

        isAuthorized = true;
        await LoadSettings();
    }

    private async Task LoadSettings()
    {
        // Load theme settings
        currentTheme = ThemeService.CurrentTheme;
        currentFontSize = ThemeService.CurrentFontSize;

        // Load security settings
        isAppLockEnabled = AppLockService.IsAppLockEnabled;
        hasPinSet = await AppLockService.HasPinSetAsync(currentUserId!);

        // Load user info
        var dbUser = await DbContext.Users.FirstOrDefaultAsync(u => u.Id == currentUserId);
        if (dbUser != null)
        {
            currentUserEmail = dbUser.Email ?? dbUser.UserName ?? "Unknown";
        }

        // Load entry count
        totalEntries = await DbContext.JournalEntries.CountAsync(e => e.UserId == currentUserId);

        // Load tags and categories
        await LoadTagsAndCategories();
    }

    private async Task LoadTagsAndCategories()
    {
        var tagsResult = await TagService.GetAllTagsAsync(currentUserId!);
        if (tagsResult.Success && tagsResult.Data != null)
        {
            customTags = tagsResult.Data.Where(t => !t.IsPrebuilt).OrderBy(t => t.Name).ToList();
        }

        var categoriesResult = await CategoryService.GetAllCategoriesAsync(currentUserId!);
        if (categoriesResult.Success && categoriesResult.Data != null)
        {
            categories = categoriesResult.Data.OrderBy(c => c.Name).ToList();
        }
    }

    private void SetTheme(string theme)
    {
        currentTheme = theme;
        ThemeService.CurrentTheme = theme;
    }

    private void OnFontSizeChanged(ChangeEventArgs e)
    {
        currentFontSize = e.Value?.ToString() ?? "Medium";
        ThemeService.CurrentFontSize = currentFontSize;
    }

    private async Task OnAppLockToggleClicked()
    {
        if (!hasPinSet)
        {
            await Application.Current!.MainPage!.DisplayAlert("PIN Required", "Please set a PIN first before enabling App Lock.", "OK");
            return;
        }

        // Toggle the state
        isAppLockEnabled = !isAppLockEnabled;
        AppLockService.IsAppLockEnabled = isAppLockEnabled;

        if (!isAppLockEnabled)
        {
            AppLockService.UnlockApp();
        }

        StateHasChanged();
    }

    private void OpenPinModal()
    {
        showPinModal = true;
        pinStep = 1;
        currentPinInput = "";
        newPinInput = "";
        confirmPinInput = "";
        pinError = "";
    }

    private void ClosePinModal()
    {
        showPinModal = false;
        pinStep = 1;
        currentPinInput = "";
        newPinInput = "";
        confirmPinInput = "";
        pinError = "";
    }

    private string GetPinButtonText()
    {
        if (hasPinSet)
        {
            return pinStep switch
            {
                1 => "Verify",
                2 => "Next",
                3 => "Save PIN",
                _ => "Continue"
            };
        }
        else
        {
            return pinStep switch
            {
                1 => "Next",
                2 => "Save PIN",
                _ => "Continue"
            };
        }
    }

    private async Task ProcessPinStep()
    {
        pinError = "";
        isProcessingPin = true;

        try
        {
            if (hasPinSet)
            {
                // Change PIN flow
                if (pinStep == 1)
                {
                    // Verify current PIN
                    var isValid = await AppLockService.ValidatePinAsync(currentUserId!, currentPinInput);
                    if (!isValid)
                    {
                        pinError = "Current PIN is incorrect.";
                        return;
                    }
                    pinStep = 2;
                }
                else if (pinStep == 2)
                {
                    // Validate new PIN format
                    if (newPinInput.Length < 4 || newPinInput.Length > 6 || !newPinInput.All(char.IsDigit))
                    {
                        pinError = "PIN must be 4-6 digits.";
                        return;
                    }
                    pinStep = 3;
                }
                else if (pinStep == 3)
                {
                    // Confirm new PIN
                    if (newPinInput != confirmPinInput)
                    {
                        pinError = "PINs do not match.";
                        return;
                    }
                    await AppLockService.SetPinAsync(currentUserId!, newPinInput);
                    await Application.Current!.MainPage!.DisplayAlert("Success", "PIN has been changed successfully.", "OK");
                    ClosePinModal();
                }
            }
            else
            {
                // Set new PIN flow
                if (pinStep == 1)
                {
                    if (newPinInput.Length < 4 || newPinInput.Length > 6 || !newPinInput.All(char.IsDigit))
                    {
                        pinError = "PIN must be 4-6 digits.";
                        return;
                    }
                    pinStep = 2;
                }
                else if (pinStep == 2)
                {
                    if (newPinInput != confirmPinInput)
                    {
                        pinError = "PINs do not match.";
                        return;
                    }
                    await AppLockService.SetPinAsync(currentUserId!, newPinInput);
                    hasPinSet = true;
                    await Application.Current!.MainPage!.DisplayAlert("Success", "PIN has been set successfully. You can now enable App Lock.", "OK");
                    ClosePinModal();
                }
            }
        }
        finally
        {
            isProcessingPin = false;
        }
    }

    private async Task RemovePin()
    {
        var confirm = await Application.Current!.MainPage!.DisplayAlert(
            "Remove PIN",
            "Are you sure you want to remove your PIN? This will disable App Lock.",
            "Remove",
            "Cancel");

        if (!confirm) return;

        await AppLockService.RemovePinAsync(currentUserId!);
        hasPinSet = false;
        isAppLockEnabled = false;
        await Application.Current!.MainPage!.DisplayAlert("Success", "PIN has been removed.", "OK");
    }

    private void ToggleTagManagement()
    {
        showTagManagement = !showTagManagement;
    }

    private void ToggleCategoryManagement()
    {
        showCategoryManagement = !showCategoryManagement;
    }

    private async Task AddCustomTag()
    {
        if (string.IsNullOrWhiteSpace(newTagName)) return;

        var result = await TagService.CreateTagAsync(currentUserId!, new TagInputModel { Name = newTagName.Trim() });
        
        if (result.Success)
        {
            newTagName = "";
            await LoadTagsAndCategories();
        }
        else
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", result.ErrorMessage ?? "Failed to add tag.", "OK");
        }
    }

    private async Task DeleteTag(int tagId)
    {
        var confirm = await Application.Current!.MainPage!.DisplayAlert("Delete Tag", "Are you sure you want to delete this tag?", "Delete", "Cancel");
        if (!confirm) return;

        var result = await TagService.DeleteTagAsync(currentUserId!, tagId);
        if (result.Success)
        {
            await LoadTagsAndCategories();
        }
        else
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", result.ErrorMessage ?? "Failed to delete tag.", "OK");
        }
    }

    private async Task AddCategory()
    {
        if (string.IsNullOrWhiteSpace(newCategoryName)) return;

        var result = await CategoryService.CreateCategoryAsync(currentUserId!, new CategoryInputModel { Name = newCategoryName.Trim() });

        if (result.Success)
        {
            newCategoryName = "";
            await LoadTagsAndCategories();
        }
        else
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", result.ErrorMessage ?? "Failed to add category.", "OK");
        }
    }

    private async Task DeleteCategory(int categoryId)
    {
        var confirm = await Application.Current!.MainPage!.DisplayAlert("Delete Category", "Are you sure you want to delete this category?", "Delete", "Cancel");
        if (!confirm) return;

        var result = await CategoryService.DeleteCategoryAsync(currentUserId!, categoryId);
        if (result.Success)
        {
            await LoadTagsAndCategories();
        }
        else
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", result.ErrorMessage ?? "Failed to delete category.", "OK");
        }
    }

    private async Task Logout()
    {
        var confirm = await Application.Current!.MainPage!.DisplayAlert("Logout", "Are you sure you want to logout?", "Logout", "Cancel");
        if (!confirm) return;

        AppLockService.LockApp();
        await CustomAuthStateProvider.MarkUserAsLoggedOut();
        Navigation.NavigateTo("/login", forceLoad: true);
    }
}