@page "/timeline"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@using PersonalJournalApp.Models.Display
@using PersonalJournalApp.Services
@using PersonalJournalApp.Auth
@using PersonalJournalApp.Data
@inject AuthenticationStateProvider AuthStateProvider
@inject CustomAuthStateProvider CustomAuthStateProvider
@inject NavigationManager Navigation
@inject JournalService JournalService
@inject TagService TagService
@inject CategoryService CategoryService
@inject AppDbContext DbContext
@inject PdfExportService PdfExportService

@if (!isAuthorized)
{
    <p>Redirecting...</p>
}
else
{
    <div class="page-content">
        <div class="page-header">
            <div class="header-left">
                <h1>Timeline</h1>
                <p class="page-subtitle">Browse all your journal entries</p>
            </div>
            <div class="header-actions">
                @if (isSelectMode)
                {
                    <span class="selected-count">@selectedEntryIds.Count selected</span>
                    <button class="btn btn-secondary" @onclick="ExportSelectedEntries" disabled="@(selectedEntryIds.Count == 0)">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export PDF
                    </button>
                    <button class="btn btn-outline" @onclick="CancelSelectMode">Cancel</button>
                }
                else
                {
                    <button class="btn btn-outline" @onclick="StartSelectMode">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 11 12 14 22 4"></polyline>
                            <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                        </svg>
                        Select & Export
                    </button>
                    <button class="btn btn-secondary" @onclick="ToggleFilters">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                        </svg>
                        @(showFilters ? "Hide Filters" : "Show Filters")
                    </button>
                    <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/today")'>
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                        New Entry
                    </button>
                }
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-bar">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text"
                   class="search-input"
                   placeholder="Search by title or content..."
                   @bind="searchQuery"
                   @bind:event="oninput"
                   @onkeyup="OnSearchChanged" />
            @if (!string.IsNullOrEmpty(searchQuery))
            {
                <button class="clear-search-btn" @onclick="ClearSearch">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            }
        </div>

        <!-- Filter Bar -->
        @if (showFilters)
        {
            <div class="filter-bar">
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <div class="date-range-inputs">
                        <input type="date" class="filter-input" @bind="filterStartDate" @bind:event="oninput" @onchange="ApplyFilters" />
                        <span class="date-separator">to</span>
                        <input type="date" class="filter-input" @bind="filterEndDate" @bind:event="oninput" @onchange="ApplyFilters" />
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Mood</label>
                    <select class="filter-select" @bind="filterMood" @bind:event="oninput" @onchange="ApplyFilters">
                        <option value="">All Moods</option>
                        <optgroup label="Positive">
                            <option value="happy">Happy</option>
                            <option value="excited">Excited</option>
                            <option value="relaxed">Relaxed</option>
                            <option value="grateful">Grateful</option>
                            <option value="confident">Confident</option>
                        </optgroup>
                        <optgroup label="Neutral">
                            <option value="calm">Calm</option>
                            <option value="thoughtful">Thoughtful</option>
                            <option value="curious">Curious</option>
                            <option value="nostalgic">Nostalgic</option>
                            <option value="bored">Bored</option>
                        </optgroup>
                        <optgroup label="Negative">
                            <option value="sad">Sad</option>
                            <option value="angry">Angry</option>
                            <option value="stressed">Stressed</option>
                            <option value="lonely">Lonely</option>
                            <option value="anxious">Anxious</option>
                        </optgroup>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Tag</label>
                    <select class="filter-select" @bind="filterTag" @bind:event="oninput" @onchange="ApplyFilters">
                        <option value="">All Tags</option>
                        @foreach (var tag in availableTags)
                        {
                            <option value="@tag.Id">@tag.Name</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Category</label>
                    <select class="filter-select" @bind="filterCategory" @bind:event="oninput" @onchange="ApplyFilters">
                        <option value="">All Categories</option>
                        @foreach (var category in availableCategories)
                        {
                            <option value="@category.Id">@category.Name</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sort</label>
                    <select class="filter-select" @bind="sortOrder" @bind:event="oninput" @onchange="ApplyFilters">
                        <option value="newest">Newest</option>
                        <option value="oldest">Oldest</option>
                        <option value="words-desc">Most Words</option>
                        <option value="words-asc">Least Words</option>
                    </select>
                </div>
                <button class="clear-filters-btn" @onclick="ClearFilters">Clear All</button>
            </div>
        }

        <!-- Loading State -->
        @if (isLoading)
        {
            <div class="loading-state">
                <p>Loading entries...</p>
            </div>
        }
        else if (filteredEntries.Count == 0)
        {
            <!-- Empty State -->
            <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                <h3>No Entries Found</h3>
                <p>@(string.IsNullOrEmpty(searchQuery) ? "You haven't written any journal entries yet." : "No entries match your search criteria.")</p>
                <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/today")'>Create Your First Entry</button>
            </div>
        }
        else
        {
            <!-- Entries List -->
            <div class="timeline-content">
                <div class="timeline-header">
                    <span class="results-count">Showing @filteredEntries.Count @(filteredEntries.Count == 1 ? "entry" : "entries")</span>
                    @if (isSelectMode)
                    {
                        <button class="select-all-btn" @onclick="ToggleSelectAll">
                            @(selectedEntryIds.Count == filteredEntries.Count ? "Deselect All" : "Select All")
                        </button>
                    }
                </div>

                <div class="entries-list">
                    @foreach (var entry in paginatedEntries)
                    {
                        <div class="entry-card @(selectedEntryIds.Contains(entry.Id) ? "selected" : "")"
                             @onclick="() => { if (isSelectMode) ToggleEntrySelection(entry.Id); }">
                            @if (isSelectMode)
                            {
                                <div class="entry-checkbox">
                                    <input type="checkbox"
                                           checked="@selectedEntryIds.Contains(entry.Id)"
                                           @onclick:stopPropagation="true"
                                           @onchange="() => ToggleEntrySelection(entry.Id)" />
                                </div>
                            }
                            <div class="entry-header">
                                <div class="entry-date">
                                    <span class="date-day">@entry.CreatedDate.ToLocalTime().Day</span>
                                    <span class="date-month">@entry.CreatedDate.ToLocalTime().ToString("MMM")</span>
                                </div>
                                <div class="entry-info">
                                    <h3 class="entry-title">@(string.IsNullOrEmpty(entry.Title) ? "Untitled Entry" : entry.Title)</h3>
                                    <div class="entry-meta">
                                        <span class="meta-item">@entry.FormattedCreatedDate</span>
                                        <span class="meta-dot">•</span>
                                        <span class="meta-item">@entry.FormattedTime</span>
                                        @if (entry.IsModified)
                                        {
                                            <span class="meta-dot">•</span>
                                            <span class="meta-item modified">Modified</span>
                                        }
                                    </div>
                                </div>
                                <div class="entry-mood">
                                    <span class="mood-badge">@FormatMoodName(entry.PrimaryMood)</span>
                                    @if (!string.IsNullOrEmpty(entry.SecondaryMood1))
                                    {
                                        <span class="mood-badge mood-secondary">+@FormatMoodName(entry.SecondaryMood1)</span>
                                    }
                                    @if (!string.IsNullOrEmpty(entry.SecondaryMood2))
                                    {
                                        <span class="mood-badge mood-secondary">+@FormatMoodName(entry.SecondaryMood2)</span>
                                    }
                                </div>
                            </div>
                            <div class="entry-content">
                                <p class="entry-excerpt">@StripHtml(entry.PreviewContent)</p>
                            </div>
                            <div class="entry-footer">
                                <div class="entry-tags">
                                    @if (!string.IsNullOrEmpty(entry.CategoryName))
                                    {
                                        <span class="tag tag-category">@entry.CategoryName</span>
                                    }
                                    @foreach (var tagName in entry.TagNames.Take(3))
                                    {
                                        <span class="tag">@tagName</span>
                                    }
                                    @if (entry.TagNames.Count > 3)
                                    {
                                        <span class="tag tag-more">+@(entry.TagNames.Count - 3)</span>
                                    }
                                </div>
                                <div class="entry-stats">
                                    <span class="stat">@entry.WordCount words</span>
                                </div>
                            </div>
                            @if (!isSelectMode)
                            {
                                <div class="entry-actions">
                                    <button class="action-btn" @onclick="() => ViewEntry(entry.Id)">
                                        <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        View
                                    </button>
                                    @if (IsToday(entry.CreatedDate))
                                    {
                                        <button class="action-btn" @onclick='() => Navigation.NavigateTo("/today")'>
                                            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                            Edit
                                        </button>
                                        <button class="action-btn danger" @onclick="() => DeleteEntry(entry.Id)">
                                            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                            Delete
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <div class="pagination">
                        <button class="pagination-btn" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Previous
                        </button>
                        <div class="pagination-pages">
                            @for (int i = 1; i <= totalPages; i++)
                            {
                                var pageNum = i;
                                @if (i == 1 || i == totalPages || (i >= currentPage - 1 && i <= currentPage + 1))
                                {
                                    <button class="page-btn @(currentPage == i ? "active" : "")" @onclick="() => GoToPage(pageNum)">@i</button>
                                }
                                else if (i == currentPage - 2 || i == currentPage + 2)
                                {
                                    <span class="pagination-dots">...</span>
                                }
                            }
                        </div>
                        <button class="pagination-btn" @onclick="NextPage" disabled="@(currentPage == totalPages)">
                            Next
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                }
            </div>
        }
    </div>
}

@code {
    private bool isAuthorized = false;
    private bool isLoading = true;
    private bool showFilters = false;
    private string? currentUserId;

    // Selection mode
    private bool isSelectMode = false;
    private HashSet<int> selectedEntryIds = new();

    // All entries
    private List<JournalEntryDisplayModel> allEntries = new();
    private List<JournalEntryDisplayModel> filteredEntries = new();
    private List<JournalEntryDisplayModel> paginatedEntries = new();

    // Filter data
    private List<PersonalJournalApp.Entities.Tag> availableTags = new();
    private List<PersonalJournalApp.Entities.Category> availableCategories = new();

    // Search and filters
    private string searchQuery = string.Empty;
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;
    private string filterMood = string.Empty;
    private string filterTag = string.Empty;
    private string filterCategory = string.Empty;
    private string sortOrder = "newest";

    // Pagination
    private int currentPage = 1;
    private const int pageSize = 10;
    private int totalPages = 0;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user?.Identity?.IsAuthenticated != true)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        var userIdClaim = user.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
        if (userIdClaim == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        currentUserId = userIdClaim.Value;

        // Verify user exists
        var userExists = await DbContext.Users.AnyAsync(u => u.Id == currentUserId);
        if (!userExists)
        {
            await CustomAuthStateProvider.MarkUserAsLoggedOut();
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadData();
        isAuthorized = true;
    }

    private async Task LoadData()
    {
        isLoading = true;

        // Load all entries
        var entriesResult = await JournalService.GetAllEntriesAsync(currentUserId!);
        if (entriesResult.Success && entriesResult.Data != null)
        {
            allEntries = entriesResult.Data;
        }

        // Load tags for filter dropdown
        var tagsResult = await TagService.GetAllTagsAsync(currentUserId!);
        if (tagsResult.Success && tagsResult.Data != null)
        {
            availableTags = tagsResult.Data.OrderBy(t => t.Name).ToList();
        }

        // Load categories for filter dropdown
        var categoriesResult = await CategoryService.GetAllCategoriesAsync(currentUserId!);
        if (categoriesResult.Success && categoriesResult.Data != null)
        {
            availableCategories = categoriesResult.Data;
        }

        ApplyFilters();
        isLoading = false;
    }

    private void ToggleFilters()
    {
        showFilters = !showFilters;
    }

    private void OnSearchChanged()
    {
        ApplyFilters();
    }

    private void ClearSearch()
    {
        searchQuery = string.Empty;
        ApplyFilters();
    }

    private void ClearFilters()
    {
        searchQuery = string.Empty;
        filterStartDate = null;
        filterEndDate = null;
        filterMood = string.Empty;
        filterTag = string.Empty;
        filterCategory = string.Empty;
        sortOrder = "newest";
        ApplyFilters();
    }

    private void StartSelectMode()
    {
        isSelectMode = true;
        selectedEntryIds.Clear();
    }

    private void CancelSelectMode()
    {
        isSelectMode = false;
        selectedEntryIds.Clear();
    }

    private void ToggleEntrySelection(int entryId)
    {
        if (selectedEntryIds.Contains(entryId))
            selectedEntryIds.Remove(entryId);
        else
            selectedEntryIds.Add(entryId);
    }

    private void ToggleSelectAll()
    {
        if (selectedEntryIds.Count == filteredEntries.Count)
        {
            selectedEntryIds.Clear();
        }
        else
        {
            selectedEntryIds = filteredEntries.Select(e => e.Id).ToHashSet();
        }
    }

    private async Task ExportSelectedEntries()
    {
        if (selectedEntryIds.Count == 0) return;

        try
        {
            var selectedEntries = allEntries
                .Where(e => selectedEntryIds.Contains(e.Id))
                .OrderByDescending(e => e.CreatedDate)
                .ToList();

            var filePath = await PdfExportService.ExportMultipleEntriesAsync(selectedEntries);

            if (!string.IsNullOrEmpty(filePath))
            {
                await Application.Current!.MainPage!.DisplayAlert(
                    "Export Successful",
                    $"{selectedEntries.Count} entries have been saved as PDF to:\n{filePath}",
                    "OK"
                );
                CancelSelectMode();
            }
            else
            {
                await Application.Current!.MainPage!.DisplayAlert(
                    "Export Cancelled",
                    "The export was cancelled.",
                    "OK"
                );
            }
        }
        catch (Exception ex)
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", "Failed to export entries: " + ex.Message, "OK");
        }
    }

    private void ApplyFilters()
    {
        filteredEntries = allEntries.ToList();

        // Search by title or content
        if (!string.IsNullOrWhiteSpace(searchQuery))
        {
            var query = searchQuery.ToLower();
            filteredEntries = filteredEntries.Where(e =>
                e.Title.ToLower().Contains(query) ||
                StripHtml(e.Content).ToLower().Contains(query)
            ).ToList();
        }

        // Filter by date range
        if (filterStartDate.HasValue)
        {
            filteredEntries = filteredEntries.Where(e => e.CreatedDate.Date >= filterStartDate.Value.Date).ToList();
        }
        if (filterEndDate.HasValue)
        {
            filteredEntries = filteredEntries.Where(e => e.CreatedDate.Date <= filterEndDate.Value.Date).ToList();
        }

        // Filter by mood
        if (!string.IsNullOrWhiteSpace(filterMood))
        {
            filteredEntries = filteredEntries.Where(e =>
                e.PrimaryMood.Equals(filterMood, StringComparison.OrdinalIgnoreCase) ||
                (!string.IsNullOrEmpty(e.SecondaryMood1) && e.SecondaryMood1.Equals(filterMood, StringComparison.OrdinalIgnoreCase)) ||
                (!string.IsNullOrEmpty(e.SecondaryMood2) && e.SecondaryMood2.Equals(filterMood, StringComparison.OrdinalIgnoreCase))
            ).ToList();
        }

        // Filter by tag
        if (!string.IsNullOrWhiteSpace(filterTag) && int.TryParse(filterTag, out int tagId))
        {
            var tagName = availableTags.FirstOrDefault(t => t.Id == tagId)?.Name;
            if (!string.IsNullOrEmpty(tagName))
            {
                filteredEntries = filteredEntries.Where(e => e.TagNames.Contains(tagName)).ToList();
            }
        }

        // Filter by category
        if (!string.IsNullOrWhiteSpace(filterCategory) && int.TryParse(filterCategory, out int categoryId))
        {
            var categoryName = availableCategories.FirstOrDefault(c => c.Id == categoryId)?.Name;
            if (!string.IsNullOrEmpty(categoryName))
            {
                filteredEntries = filteredEntries.Where(e => e.CategoryName == categoryName).ToList();
            }
        }

        // Sort
        filteredEntries = sortOrder switch
        {
            "oldest" => filteredEntries.OrderBy(e => e.CreatedDate).ToList(),
            "words-desc" => filteredEntries.OrderByDescending(e => e.WordCount).ToList(),
            "words-asc" => filteredEntries.OrderBy(e => e.WordCount).ToList(),
            _ => filteredEntries.OrderByDescending(e => e.CreatedDate).ToList() // newest (default)
        };

        // Reset to page 1 when filters change
        currentPage = 1;
        UpdatePagination();
    }

    private void UpdatePagination()
    {
        totalPages = (int)Math.Ceiling((double)filteredEntries.Count / pageSize);
        if (totalPages < 1) totalPages = 1;
        if (currentPage > totalPages) currentPage = totalPages;

        var skip = (currentPage - 1) * pageSize;
        paginatedEntries = filteredEntries.Skip(skip).Take(pageSize).ToList();
    }

    private void GoToPage(int page)
    {
        currentPage = page;
        UpdatePagination();
    }

    private void PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            UpdatePagination();
        }
    }

    private void NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            UpdatePagination();
        }
    }

    private bool IsToday(DateTime dateTime)
    {
        return dateTime.ToLocalTime().Date == DateTime.Now.Date;
    }

    private void ViewEntry(int entryId)
    {
        Navigation.NavigateTo($"/entry/{entryId}");
    }

    private async Task DeleteEntry(int entryId)
    {
        bool confirmed = await Application.Current!.MainPage!.DisplayAlert(
            "Delete Entry",
            "Are you sure you want to delete this entry? This action cannot be undone.",
            "Delete",
            "Cancel"
        );

        if (!confirmed) return;

        var result = await JournalService.DeleteEntryAsync(currentUserId!, entryId);

        if (result.Success)
        {
            await Application.Current!.MainPage!.DisplayAlert("Success", "Entry deleted successfully.", "OK");
            await LoadData(); // Reload data
        }
        else
        {
            await Application.Current!.MainPage!.DisplayAlert("Error", result.ErrorMessage ?? "Failed to delete entry.", "OK");
        }
    }

    private string FormatMoodName(string mood)
    {
        return System.Globalization.CultureInfo.CurrentCulture.TextInfo.ToTitleCase(mood.ToLower());
    }

    private string StripHtml(string html)
    {
        if (string.IsNullOrEmpty(html)) return string.Empty;

        // Simple HTML stripping - remove tags
        var text = System.Text.RegularExpressions.Regex.Replace(html, "<.*?>", string.Empty);
        // Decode HTML entities
        text = System.Net.WebUtility.HtmlDecode(text);
        return text.Trim();
    }
}