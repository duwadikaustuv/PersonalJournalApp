@page "/timeline"

@if (!isAuthorized)
{
    <p>Redirecting...</p>
}
else
{
    <div class="page-content">
        <div class="page-header">
            <div class="header-left">
                <h1>Timeline</h1>
                <p class="page-subtitle">Browse all your journal entries</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" @onclick="ToggleFilters">
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    @(showFilters ? "Hide Filters" : "Show Filters")
                </button>
                <div class="export-dropdown">
                    <button class="btn btn-secondary" @onclick="ToggleExportMenu">
                        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export
                        <svg class="dropdown-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="6 9 12 15 18 9"></polyline>
                        </svg>
                    </button>
                    @if (showExportMenu)
                    {
                        <div class="export-menu">
                            <button class="export-option" @onclick="ExportAllEntries">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                Export All (@allEntries.Count entries)
                            </button>
                            <button class="export-option" @onclick="ExportFilteredEntries" disabled="@(filteredEntries.Count == allEntries.Count)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                </svg>
                                Export Filtered (@filteredEntries.Count entries)
                            </button>
                            <div class="export-divider"></div>
                            <button class="export-option" @onclick="OpenDateRangeExport">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                    <line x1="16" y1="2" x2="16" y2="6"></line>
                                    <line x1="8" y1="2" x2="8" y2="6"></line>
                                    <line x1="3" y1="10" x2="21" y2="10"></line>
                                </svg>
                                Export by Date Range...
                            </button>
                        </div>
                    }
                </div>
                <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/today")'>
                    <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Entry
                </button>
            </div>
        </div>

        <!-- Search Bar -->
        <div class="search-bar">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
            <input type="text"
                   class="search-input"
                   placeholder="Search by title or content..."
                   @bind="searchQuery"
                   @bind:event="oninput"
                   @onkeyup="OnSearchChanged" />
            @if (!string.IsNullOrEmpty(searchQuery))
            {
                <button class="clear-search-btn" @onclick="ClearSearch">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            }
        </div>

        <!-- Filter Bar -->
        @if (showFilters)
        {
            <div class="filter-bar">
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <div class="date-range-inputs">
                        <input type="date" class="filter-input" @bind="filterStartDate" @bind:event="oninput" @onchange="ApplyFilters" />
                        <span class="date-separator">to</span>
                        <input type="date" class="filter-input" @bind="filterEndDate" @bind:event="oninput" @onchange="ApplyFilters" />
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Mood</label>
                    <select class="filter-select" @bind="filterMood" @bind:event="oninput" @onchange="ApplyFilters">
                        <option value="">All Moods</option>
                        <optgroup label="Positive">
                            <option value="happy">Happy</option>
                            <option value="excited">Excited</option>
                            <option value="relaxed">Relaxed</option>
                            <option value="grateful">Grateful</option>
                            <option value="confident">Confident</option>
                        </optgroup>
                        <optgroup label="Neutral">
                            <option value="calm">Calm</option>
                            <option value="thoughtful">Thoughtful</option>
                            <option value="curious">Curious</option>
                            <option value="nostalgic">Nostalgic</option>
                            <option value="bored">Bored</option>
                        </optgroup>
                        <optgroup label="Negative">
                            <option value="sad">Sad</option>
                            <option value="angry">Angry</option>
                            <option value="stressed">Stressed</option>
                            <option value="lonely">Lonely</option>
                            <option value="anxious">Anxious</option>
                        </optgroup>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Tag</label>
                    <select class="filter-select" @bind="filterTag" @bind:event="oninput" @onchange="ApplyFilters">
                        <option value="">All Tags</option>
                        @foreach (var tag in availableTags)
                        {
                            <option value="@tag.Id">@tag.Name</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Category</label>
                    <select class="filter-select" @bind="filterCategory" @bind:event="oninput" @onchange="ApplyFilters">
                        <option value="">All Categories</option>
                        @foreach (var category in availableCategories)
                        {
                            <option value="@category.Id">@category.Name</option>
                        }
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sort</label>
                    <select class="filter-select" @bind="sortOrder" @bind:event="oninput" @onchange="ApplyFilters">
                        <option value="newest">Newest</option>
                        <option value="oldest">Oldest</option>
                        <option value="words-desc">Most Words</option>
                        <option value="words-asc">Least Words</option>
                    </select>
                </div>
                <button class="clear-filters-btn" @onclick="ClearFilters">Clear All</button>
            </div>
        }

        <!-- Date Range Export Modal -->
        @if (showDateRangeModal)
        {
            <div class="modal-overlay" @onclick="CloseDateRangeModal">
                <div class="modal-content" @onclick:stopPropagation>
                    <div class="modal-header">
                        <h3>Export by Date Range</h3>
                        <button class="modal-close" @onclick="CloseDateRangeModal">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body">
                        @if (!string.IsNullOrEmpty(exportError))
                        {
                            <div class="export-error">@exportError</div>
                        }

                        <div class="date-range-form">
                            <div class="form-group">
                                <label>Start Date</label>
                                <input type="date" class="form-input" @bind="exportStartDate" max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                            </div>
                            <div class="form-group">
                                <label>End Date</label>
                                <input type="date" class="form-input" @bind="exportEndDate" max="@DateTime.Now.ToString("yyyy-MM-dd")" />
                            </div>
                        </div>

                        @if (exportStartDate.HasValue && exportEndDate.HasValue)
                        {
                            var entriesInRange = GetEntriesInDateRange(exportStartDate.Value, exportEndDate.Value);
                            <div class="export-preview">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                    <polyline points="14 2 14 8 20 8"></polyline>
                                </svg>
                                <span>@entriesInRange.Count entries found in this date range</span>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" @onclick="CloseDateRangeModal">Cancel</button>
                        <button class="btn btn-primary" @onclick="ExportByDateRange" disabled="@(!exportStartDate.HasValue || !exportEndDate.HasValue || isExporting)">
                            @if (isExporting)
                            {
                                <span>Exporting...</span>
                            }
                            else
                            {
                                <span>Export PDF</span>
                            }
                        </button>
                    </div>
                </div>
            </div>
        }

        <!-- Export Success Toast -->
        @if (showExportSuccess)
        {
            <div class="export-toast success">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
                <span>PDF exported successfully!</span>
            </div>
        }

        <!-- Loading State -->
        @if (isLoading)
        {
            <div class="loading-state">
                <p>Loading entries...</p>
            </div>
        }
        else if (filteredEntries.Count == 0)
        {
            <!-- Empty State -->
            <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                <h3>No Entries Found</h3>
                <p>@(string.IsNullOrEmpty(searchQuery) ? "You haven't written any journal entries yet." : "No entries match your search criteria.")</p>
                <button class="btn btn-primary" @onclick='() => Navigation.NavigateTo("/today")'>Create Your First Entry</button>
            </div>
        }
        else
        {
            <!-- Entries List -->
            <div class="timeline-content">
                <div class="timeline-header">
                    <span class="results-count">Showing @filteredEntries.Count @(filteredEntries.Count == 1 ? "entry" : "entries")</span>
                    @if (isSelectMode)
                    {
                        <button class="select-all-btn" @onclick="ToggleSelectAll">
                            @(selectedEntryIds.Count == filteredEntries.Count ? "Deselect All" : "Select All")
                        </button>
                    }
                </div>

                <div class="entries-list">
                    @foreach (var entry in paginatedEntries)
                    {
                        <div class="entry-card @(selectedEntryIds.Contains(entry.Id) ? "selected" : "")"
                             @onclick="() => { if (isSelectMode) ToggleEntrySelection(entry.Id); }">
                            @if (isSelectMode)
                            {
                                <div class="entry-checkbox">
                                    <input type="checkbox"
                                           checked="@selectedEntryIds.Contains(entry.Id)"
                                           @onclick:stopPropagation="true"
                                           @onchange="() => ToggleEntrySelection(entry.Id)" />
                                </div>
                            }
                            <div class="entry-header">
                                <div class="entry-date">
                                    <span class="date-day">@entry.CreatedDate.ToLocalTime().Day</span>
                                    <span class="date-month">@entry.CreatedDate.ToLocalTime().ToString("MMM")</span>
                                </div>
                                <div class="entry-info">
                                    <h3 class="entry-title">@(string.IsNullOrEmpty(entry.Title) ? "Untitled Entry" : entry.Title)</h3>
                                    <div class="entry-meta">
                                        <span class="meta-item">@entry.FormattedCreatedDate</span>
                                        <span class="meta-dot">•</span>
                                        <span class="meta-item">@entry.FormattedTime</span>
                                        @if (entry.IsModified)
                                        {
                                            <span class="meta-dot">•</span>
                                            <span class="meta-item modified">Modified</span>
                                        }
                                    </div>
                                </div>
                                <div class="entry-mood">
                                    <span class="mood-badge">@FormatMoodName(entry.PrimaryMood)</span>
                                    @if (!string.IsNullOrEmpty(entry.SecondaryMood1))
                                    {
                                        <span class="mood-badge mood-secondary">+@FormatMoodName(entry.SecondaryMood1)</span>
                                    }
                                    @if (!string.IsNullOrEmpty(entry.SecondaryMood2))
                                    {
                                        <span class="mood-badge mood-secondary">+@FormatMoodName(entry.SecondaryMood2)</span>
                                    }
                                </div>
                            </div>
                            <div class="entry-content">
                                <p class="entry-excerpt">@StripHtml(entry.PreviewContent)</p>
                            </div>
                            <div class="entry-footer">
                                <div class="entry-tags">
                                    @if (!string.IsNullOrEmpty(entry.CategoryName))
                                    {
                                        <span class="tag tag-category">@entry.CategoryName</span>
                                    }
                                    @foreach (var tagName in entry.TagNames.Take(3))
                                    {
                                        <span class="tag">@tagName</span>
                                    }
                                    @if (entry.TagNames.Count > 3)
                                    {
                                        <span class="tag tag-more">+@(entry.TagNames.Count - 3)</span>
                                    }
                                </div>
                                <div class="entry-stats">
                                    <span class="stat">@entry.WordCount words</span>
                                </div>
                            </div>
                            @if (!isSelectMode)
                            {
                                <div class="entry-actions">
                                    <button class="action-btn" @onclick="() => ViewEntry(entry.Id)">
                                        <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                        View
                                    </button>
                                    @if (IsToday(entry.CreatedDate))
                                    {
                                        <button class="action-btn" @onclick='() => Navigation.NavigateTo("/today")'>
                                            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                            </svg>
                                            Edit
                                        </button>
                                        <button class="action-btn danger" @onclick="() => DeleteEntry(entry.Id)">
                                            <svg class="action-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                            Delete
                                        </button>
                                    }
                                </div>
                            }
                        </div>
                    }
                </div>

                <!-- Pagination -->
                @if (totalPages > 1)
                {
                    <div class="pagination">
                        <button class="pagination-btn" @onclick="PreviousPage" disabled="@(currentPage == 1)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                            Previous
                        </button>
                        <div class="pagination-pages">
                            @for (int i = 1; i <= totalPages; i++)
                            {
                                var pageNum = i;
                                @if (i == 1 || i == totalPages || (i >= currentPage - 1 && i <= currentPage + 1))
                                {
                                    <button class="page-btn @(currentPage == i ? "active" : "")" @onclick="() => GoToPage(pageNum)">@i</button>
                                }
                                else if (i == currentPage - 2 || i == currentPage + 2)
                                {
                                    <span class="pagination-dots">...</span>
                                }
                            }
                        </div>
                        <button class="pagination-btn" @onclick="NextPage" disabled="@(currentPage == totalPages)">
                            Next
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>
                }
            </div>
        }
    </div>
}

